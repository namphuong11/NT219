\chapter{QUIC Frame-\/in-\/\+Flight Management}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm}{}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm}\index{QUIC Frame-\/in-\/Flight Management@{QUIC Frame-\/in-\/Flight Management}}
The QUIC frame-\/in-\/flight manager is responsible for tracking frames which were sent which need to be regenerated if the packets they were placed into are designated as lost by the ACK manager. The ACK manager works on the level of packets, whereas the QUIC frame-\/in-\/flight manager (FIFM) works on the level of frames.

The FIFM comprises three components, collectively known as the FIFM\+:


\begin{DoxyItemize}
\item the Control Frame Queue (CFQ);
\item the Transmitted Packet Information Manager (TXPIM); and
\item the Frame-\/in-\/\+Flight Dispatcher (FIFD).
\end{DoxyItemize}



These are introduced in turn below, but first we discuss the various QUIC frame types to establish the need for each component.\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md397}{}\doxysection{\texorpdfstring{Analysis of QUIC Frame Retransmission Requirements}{Analysis of QUIC Frame Retransmission Requirements}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md397}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md398}{}\doxysubsection{\texorpdfstring{Frame Types}{Frame Types}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md398}
Standard QUIC uses the following frame types\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{HANDSHAKE\_DONE\ \ \ \ \ \ \ \ \ \ GCR\ /\ REGEN}
\DoxyCodeLine{MAX\_DATA\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{DATA\_BLOCKED\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{MAX\_STREAMS\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{STREAMS\_BLOCKED\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{NEW\_CONNECTION\_ID\ \ \ \ \ \ \ \ \ \ \ \ \ GCR}
\DoxyCodeLine{RETIRE\_CONNECTION\_ID\ \ \ \ \ \ \ \ \ \ GCR}
\DoxyCodeLine{PATH\_CHALLENGE\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/}
\DoxyCodeLine{PATH\_RESPONSE\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/}
\DoxyCodeLine{ACK\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/\ \ \ \ \ \ \ \ (non-\/ACK-\/eliciting)}
\DoxyCodeLine{CONNECTION\_CLOSE\ \ \ \ \ \ \ \ \ \ \ \ \ \ special\ \ \ \ (non-\/ACK-\/eliciting)}
\DoxyCodeLine{NEW\_TOKEN\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GCR}
\DoxyCodeLine{CRYPTO\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GCR\ or\ special}
\DoxyCodeLine{RESET\_STREAM\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{STOP\_SENDING\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{MAX\_STREAM\_DATA\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{STREAM\_DATA\_BLOCKED\ \ \ \ \ \ \ \ \ \ \ REGEN}
\DoxyCodeLine{STREAM\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ special}
\DoxyCodeLine{PING\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/}
\DoxyCodeLine{PADDING\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ -\/\ \ \ \ \ \ \ \ \ (non-\/ACK-\/eliciting)}

\end{DoxyCode}


The different frame types require various different ways of handling retransmission in the event of loss\+:


\begin{DoxyItemize}
\item {\bfseries{GCR}} (Generic Control Frame Retransmission)\+: The raw bytes of the encoded frame can simply be sent again. This retransmission system does not need to understand the specific frame type. A simple queue can be used, with each queue entry being an octet string representing an encoded frame. This queue can also be used for initial transmission of {\bfseries{GCR}} frames, not just retransmissions.
\item {\bfseries{REGEN}} (Regenerate)\+: These frames can be marked for dynamic regeneration when a packet containing them is lost. This has the advantage of using up-\/to-\/date data at the time of transmission, so is preferred over {\ttfamily GCR} when possible.
\item Special — {\ttfamily STREAM}, {\ttfamily CRYPTO}\+: {\ttfamily STREAM} frame handling is handled as a special case by the QUIC Send Stream Manager. {\ttfamily CRYPTO} frame retransmission can also be handled using a QUIC Send Stream manager. ({\ttfamily CRYPTO} frames could also be handled via GCR, though suboptimally. We choose to use proper send stream management, just as for application data streams.)
\item Some frame types do not need to be retransmitted even if lost ({\ttfamily PING}, {\ttfamily PADDING}, {\ttfamily PATH\+\_\+\+CHALLENGE}, {\ttfamily PATH\+\_\+\+RESPONSE}).
\item Special — {\ttfamily CONNECTION\+\_\+\+CLOSE}\+: This frame is a special case and is not retransmitted per se.
\end{DoxyItemize}\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md399}{}\doxysubsection{\texorpdfstring{Requirements}{Requirements}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md399}
The following requirements are identified\+:


\begin{DoxyItemize}
\item Need for a generic control queue which can store encoded control frames. This control queue will handle both initial transmission and retransmission of most control frames which do not have special requirements.
\item The ability to determine, when the ACK Manager determines that a packet has been acknowledged, lost or discarded\+:
\begin{DoxyItemize}
\item What stream IDs were sent in a packet, and the logical ranges of application data bytes for each (which may not be one contiguous range).

This is needed so that the QUIC Send Stream Manager for a given stream can be informed of lost or acked ranges in the stream.
\item The logical ranges of the CRYPTO stream which were sent in the packet (which may not be one contiguous range), for similar reasons.
\item Which stream IDs had a FIN bit set in the packet.

This is needed so that the QUIC Send Stream Manager can be informed for a given stream whether a FIN was lost or acked.
\item What control frames using the {\bfseries{GCR}} strategy were sent in the packet so that they can be requeued (if lost) or released (if acked or discarded).
\item For each type of frame using the {\bfseries{REGEN}} strategy, a flag as to whether that frame type was contained in the packet (so that the flag can be set again if the packet was lost).
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md400}{}\doxysection{\texorpdfstring{The Control Frame Queue (CFQ)}{The Control Frame Queue (CFQ)}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md400}


The CFQ ({\ttfamily QUIC\+\_\+\+CFQ}) stores encoded frames which can be blindly retransmitted in the event that they are lost. It facilitates the GCR retransmission strategy. One logical CFQ instance will be needed per PN space per connection. As an optimisation, these three CFQ instances per connection are all modelled by a single {\ttfamily QUIC\+\_\+\+CFQ} instance.

Each frame in the CFQ is a simple opaque byte buffer, which has the following metadata associated with it\+:


\begin{DoxyItemize}
\item An integral priority value, used to maintain priority ordering.
\item The frame type, which is provided by the caller along with the buffer. This can be determined from the encoded frame buffer, but this saves the CFQ\textquotesingle{}s users from needing to decode it. The CFQ itself does not use this value.
\item A state, which is either {\ttfamily NEW} or {\ttfamily TX}. Frames added to the CFQ have the {\ttfamily NEW} state initially. When the frame is transmitted, it is transitioned to the {\ttfamily TX} state. If the packet it was sent in is subsequently lost, it is transitioned back to the {\ttfamily NEW} state.
\end{DoxyItemize}

Frames in the {\ttfamily NEW} state participate in a priority queue (the NEW queue) according to their priority and the CFQ\textquotesingle{}s NEW queue can be iterated in priority order by callers.

When a packet containing a CFQ item is acknowledged, the CFQ is informed and the CFQ item is released. A free callback provided when the buffer was added to the CFQ is called, providing an opportunity to free or reuse the buffer. Buffers provided to the CFQ as part of a CFQ item must remain allocated for the duration of their membership of the CFQ. The CFQ maintains memory allocation of CFQ items themselves internally.\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md401}{}\doxysubsection{\texorpdfstring{API}{API}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md401}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ QUIC\ Control\ Frame\ Queue\ Item}}
\DoxyCodeLine{\textcolor{comment}{\ *\ =============================}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ The\ CFQ\ item\ structure\ has\ a\ public\ and\ a\ private\ part.\ This\ structure}}
\DoxyCodeLine{\textcolor{comment}{\ *\ documents\ the\ public\ part.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__cfq__item__st}{quic\_cfq\_item\_st}}\ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__cfq__item__st}{quic\_cfq\_item\_st}}\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ These\ fields\ are\ not\ used\ by\ the\ CFQ,\ but\ are\ a\ convenience\ to\ assist\ the}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ TXPIM\ in\ keeping\ a\ list\ of\ GCR\ control\ frames\ which\ were\ sent\ in\ a}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ packet.\ They\ may\ be\ used\ for\ any\ purpose.}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ \ *pkt\_prev,\ *pkt\_next;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ All\ other\ fields\ are\ private;\ use\ ossl\_quic\_cfq\_item\_*\ accessors.\ */}}
\DoxyCodeLine{\};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#define\ QUIC\_CFQ\_STATE\_NEW\ \ \ \ \ \ 0}}
\DoxyCodeLine{\textcolor{preprocessor}{\#define\ QUIC\_CFQ\_STATE\_TX\ \ \ \ \ \ \ 1}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Returns\ the\ frame\ type\ of\ a\ CFQ\ item.\ */}}
\DoxyCodeLine{uint64\_t\ ossl\_quic\_cfq\_item\_get\_frame\_type(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Returns\ a\ pointer\ to\ the\ encoded\ buffer\ of\ a\ CFQ\ item.\ */}}
\DoxyCodeLine{\textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *ossl\_quic\_cfq\_item\_get\_encoded(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Returns\ the\ length\ of\ the\ encoded\ buffer\ in\ bytes.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{size\_t}\ ossl\_quic\_cfq\_item\_get\_encoded\_len(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Returns\ the\ CFQ\ item\ state,\ a\ QUIC\_CFQ\_STATE\_*\ value.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ ossl\_quic\_cfg\_item\_get\_state(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Returns\ the\ PN\ space\ for\ the\ CFQ\ item.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ ossl\_quic\_cfg\_item\_get\_pn\_space(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ QUIC\ Control\ Frame\ Queue}}
\DoxyCodeLine{\textcolor{comment}{\ *\ ========================}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__cfq__st}{quic\_cfq\_st}}\ \mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}};}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *ossl\_quic\_cfq\_new(\textcolor{keywordtype}{void});}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_cfq\_free(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Input\ Side}}
\DoxyCodeLine{\textcolor{comment}{\ *\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Enqueue\ a\ frame\ to\ the\ CFQ.\ encoded\ points\ to\ the\ opaque\ encoded\ frame.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ free\_cb\ is\ called\ by\ the\ CFQ\ when\ the\ buffer\ is\ no\ longer\ needed;}}
\DoxyCodeLine{\textcolor{comment}{\ *\ free\_cb\_arg\ is\ an\ opaque\ value\ passed\ to\ free\_cb.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ priority\ determines\ the\ relative\ ordering\ of\ control\ frames\ in\ a\ packet.}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Higher\ numerical\ values\ for\ priority\ mean\ that\ a\ frame\ should\ come\ earlier\ in}}
\DoxyCodeLine{\textcolor{comment}{\ *\ a\ packet.\ pn\_space\ is\ a\ QUIC\_PN\_SPACE\_*\ value.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ On\ success,\ returns\ a\ QUIC\_CFQ\_ITEM\ pointer\ which\ acts\ as\ a\ handle\ to}}
\DoxyCodeLine{\textcolor{comment}{\ *\ the\ queued\ frame.\ On\ failure,\ returns\ NULL.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ The\ frame\ is\ initially\ in\ the\ TX\ state,\ so\ there\ is\ no\ need\ to\ call}}
\DoxyCodeLine{\textcolor{comment}{\ *\ ossl\_quic\_cfq\_mark\_tx()\ immediately\ after\ calling\ this\ function.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ The\ frame\ type\ is\ duplicated\ as\ the\ frame\_type\ argument\ here,\ even\ though\ it}}
\DoxyCodeLine{\textcolor{comment}{\ *\ is\ also\ encoded\ into\ the\ buffer.\ This\ allows\ the\ caller\ to\ determine\ the}}
\DoxyCodeLine{\textcolor{comment}{\ *\ frame\ type\ if\ desired\ without\ having\ to\ decode\ the\ frame.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ void\ (cfq\_free\_cb)(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *buf,\ \textcolor{keywordtype}{size\_t}\ buf\_len,\ \textcolor{keywordtype}{void}\ *arg);}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *ossl\_quic\_cfq\_add\_frame(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ \ \ \ \ \ \ \ \ \ \ \ *cfq,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ \ \ \ \ \ \ \ \ \ \ \ \ priority,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ \ \ \ \ \ \ \ \ \ \ \ \ pn\_space,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ \ \ \ \ \ \ \ \ \ \ \ \ frame\_type,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{char}\ *encoded,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ encoded\_len,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cfq\_free\_cb\ \ \ \ \ \ \ \ \ *free\_cb,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ *free\_cb\_arg);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Effects\ an\ immediate\ transition\ of\ the\ given\ CFQ\ item\ to\ the\ TX\ state.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_cfq\_mark\_tx(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq,\ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Effects\ an\ immediate\ transition\ of\ the\ given\ CFQ\ item\ to\ the\ NEW\ state,}}
\DoxyCodeLine{\textcolor{comment}{\ *\ allowing\ the\ frame\ to\ be\ retransmitted.\ If\ priority\ is\ not\ UINT32\_MAX,}}
\DoxyCodeLine{\textcolor{comment}{\ *\ the\ priority\ is\ changed\ to\ the\ given\ value.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_cfq\_mark\_lost(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq,\ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ priority);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Releases\ a\ CFQ\ item.\ The\ item\ may\ be\ in\ either\ state\ (NEW\ or\ TX)\ prior\ to\ the}}
\DoxyCodeLine{\textcolor{comment}{\ *\ call.\ The\ QUIC\_CFQ\_ITEM\ pointer\ must\ not\ be\ used\ following\ this\ call.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_cfq\_release(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq,\ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Output\ Side}}
\DoxyCodeLine{\textcolor{comment}{\ *\ -\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Gets\ the\ highest\ priority\ CFQ\ item\ in\ the\ given\ PN\ space\ awaiting}}
\DoxyCodeLine{\textcolor{comment}{\ *\ transmission.\ If\ there\ are\ none,\ returns\ NULL.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *ossl\_quic\_cfq\_get\_priority\_head(\mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq,\ uint32\_t\ pn\_space);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Given\ a\ CFQ\ item,\ gets\ the\ next\ CFQ\ item\ awaiting\ transmission\ in\ priority}}
\DoxyCodeLine{\textcolor{comment}{\ *\ order\ in\ the\ given\ PN\ space.\ In\ other\ words,\ given\ the\ return\ value\ of}}
\DoxyCodeLine{\textcolor{comment}{\ *\ ossl\_quic\_cfq\_get\_priority\_head(),\ returns\ the\ next-\/lower\ priority\ item.}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Returns\ NULL\ if\ the\ given\ item\ is\ the\ last\ item\ in\ priority\ order.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *ossl\_quic\_cfq\_item\_get\_priority\_next(\mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint32\_t\ pn\_space);}

\end{DoxyCode}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md402}{}\doxysection{\texorpdfstring{The Transmitted Packet Information Manager (TXPIM)}{The Transmitted Packet Information Manager (TXPIM)}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md402}


The Transmitted Packet Information Manager ({\ttfamily QUIC\+\_\+\+TXPIM}) is responsible for allocating and keeping bookkeeping structures for packets which have been transmitted, but not yet acknowledged, deemed lost or discarded. It is a self-\/contained memory pool handing out {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} structures. Each {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} is a self-\/contained data structure intended for consumption by the FIFM.

The {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} structure can be used for\+:


\begin{DoxyItemize}
\item Keeping track of all GCR control frames which were transmitted in each packet, via a linked list of {\ttfamily QUIC\+\_\+\+CFQ\+\_\+\+ITEM}s.
\item Keeping track of all REGEN-\/strategy control frame types, via a flag for each frame type indicating whether the packet contained such a frame.
\item Keeping track of all stream IDs sent in a given packet, and what ranges of the logical stream were sent, and whether a FIN was sent.
\item Keeping track of what logical ranges of the CRYPTO stream were sent.
\end{DoxyItemize}

In order to avoid unnecessary allocations, the FIFM also incorporates the ACK Manager\textquotesingle{}s {\ttfamily QUIC\+\_\+\+ACKM\+\_\+\+TX\+\_\+\+PKT} structure into its per-\/packet bookkeeping structure. The intention is for the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} to be the principal allocation made per transmitted packet. The TX packetiser will obtain a {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} structure from the TXPIM, fill in the structure including the ACK Manager data, and submit it via the FIFD which we introduce below.

The TXPIM does do not anything with the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} structure itself other than managing its allocation and manipulation. Constructive use of the data kept in the TXPIM is made by the FIFD.\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md403}{}\doxysubsection{\texorpdfstring{API}{API}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md403}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ QUIC\ Transmitted\ Packet\ Information\ Manager}}
\DoxyCodeLine{\textcolor{comment}{\ *\ ===========================================}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__txpim__st}{quic\_txpim\_st}}\ \mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__txpim__pkt__st}{quic\_txpim\_pkt\_st}}\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ ACKM-\/specific\ data.\ Caller\ should\ fill\ this.\ */}}
\DoxyCodeLine{\ \ \ \ QUIC\_ACKM\_TX\_PKT\ \ \ \ ackm\_pkt;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Linked\ list\ of\ CFQ\ items\ in\ this\ packet.\ */}}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ \ \ \ \ \ *retx\_head;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Reserved\ for\ FIFD\ use.\ */}}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{structquic__fifd__st}{QUIC\_FIFD}}\ \ \ \ \ \ \ \ \ \ *fifd;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Regenerate-\/strategy\ frames.\ */}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ had\_handshake\_done\ \ \ \ \ \ \ \ \ \ :\ 1;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ had\_max\_data\_frame\ \ \ \ \ \ \ \ \ \ :\ 1;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ had\_max\_streams\_bidi\_frame\ \ :\ 1;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ had\_max\_streams\_uni\_frame\ \ \ :\ 1;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ \ \ \ \ had\_ack\_frame\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ :\ 1;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Private\ data\ follows.\ */}}
\DoxyCodeLine{\}\ \mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Represents\ a\ range\ of\ bytes\ in\ an\ application\ or\ CRYPTO\ stream.\ */}}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__txpim__chunk__st}{quic\_txpim\_chunk\_st}}\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ The\ stream\ ID,\ or\ UINT64\_MAX\ for\ the\ CRYPTO\ stream.\ */}}
\DoxyCodeLine{\ \ \ \ uint64\_t\ \ \ \ \ \ \ \ stream\_id;}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ The\ inclusive\ range\ of\ bytes\ in\ the\ stream.\ Exceptionally,\ if\ end\ <}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ start,\ designates\ a\ frame\ of\ zero\ length\ (used\ for\ FIN-\/only\ frames).}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{\ \ \ \ uint64\_t\ \ \ \ \ \ \ \ start,\ end;}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ Whether\ a\ FIN\ was\ sent\ for\ this\ stream\ in\ the\ packet.\ Not\ valid\ for}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ *\ CRYPTO\ stream.}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ \ */}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \ \ \ has\_fin\ :\ 1;}
\DoxyCodeLine{\}\ \mbox{\hyperlink{structquic__txpim__chunk__st}{QUIC\_TXPIM\_CHUNK}};}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *ossl\_quic\_txpim\_new(\textcolor{keywordtype}{void});}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_txpim\_free(\mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *txpim);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Allocates\ a\ new\ QUIC\_TXPIM\_PKT\ structure\ from\ the\ pool.\ Returns\ NULL\ on}}
\DoxyCodeLine{\textcolor{comment}{\ *\ failure.\ The\ returned\ structure\ is\ cleared\ of\ all\ data\ and\ is\ in\ a\ fresh}}
\DoxyCodeLine{\textcolor{comment}{\ *\ initial\ state.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *ossl\_quic\_txpim\_pkt\_alloc(\mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *txpim);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Releases\ the\ TXPIM\ packet,\ returning\ it\ to\ the\ pool.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_txpim\_pkt\_release(\mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *txpim,\ \mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Clears\ the\ chunk\ list\ of\ the\ packet,\ removing\ all\ entries.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_txpim\_pkt\_clear\_chunks(\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Appends\ a\ chunk\ to\ the\ packet.\ The\ structure\ is\ copied.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ ossl\_quic\_txpim\_pkt\_append\_chunk(\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{structquic__txpim__chunk__st}{QUIC\_TXPIM\_CHUNK}}\ *chunk);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ Adds\ a\ CFQ\ item\ to\ the\ packet\ by\ prepending\ it\ to\ the\ retx\_head\ list.\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_txpim\_pkt\_add\_cfq\_item(\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structquic__cfq__item__st}{QUIC\_CFQ\_ITEM}}\ *item);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Returns\ a\ pointer\ to\ an\ array\ of\ stream\ chunk\ information\ structures\ for\ the}}
\DoxyCodeLine{\textcolor{comment}{\ *\ given\ packet.\ The\ caller\ must\ call\ ossl\_quic\_txpim\_pkt\_get\_num\_chunks()\ to}}
\DoxyCodeLine{\textcolor{comment}{\ *\ determine\ the\ length\ of\ this\ array.}}
\DoxyCodeLine{\textcolor{comment}{\ *}}
\DoxyCodeLine{\textcolor{comment}{\ *\ The\ chunks\ are\ sorted\ by\ (stream\_id,\ start)\ in\ ascending\ order.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keyword}{const}\ \mbox{\hyperlink{structquic__txpim__chunk__st}{QUIC\_TXPIM\_CHUNK}}\ *ossl\_quic\_txpim\_pkt\_get\_chunks(\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Returns\ the\ number\ of\ entries\ in\ the\ array\ returned\ by}}
\DoxyCodeLine{\textcolor{comment}{\ *\ ossl\_quic\_txpim\_pkt\_get\_chunks().}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{size\_t}\ ossl\_quic\_txpim\_pkt\_get\_num\_chunks(\mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *fpkt);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*}}
\DoxyCodeLine{\textcolor{comment}{\ *\ Returns\ the\ number\ of\ QUIC\_TXPIM\_PKTs\ allocated\ by\ the\ given\ TXPIM\ that\ have}}
\DoxyCodeLine{\textcolor{comment}{\ *\ yet\ to\ be\ returned\ to\ the\ TXPIM.}}
\DoxyCodeLine{\textcolor{comment}{\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{size\_t}\ ossl\_quic\_txpim\_get\_in\_use(\mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *txpim);}

\end{DoxyCode}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md404}{}\doxysection{\texorpdfstring{The Frame-\/in-\/\+Flight Dispatcher (FIFD)}{The Frame-\/in-\/\+Flight Dispatcher (FIFD)}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md404}
Finally, the CFQ, TXPIM and some interfaces to the ACKM are tied together via the FIFD ({\ttfamily QUIC\+\_\+\+FIFD}). The FIFD is completely stateless and provides reasonable implementations for the on-\/loss, on-\/acked and on-\/discarded callbacks issued by the ACK Manager.

The FIFD is used by obtaining a packet structure from the TXPIM, filling it in, and then calling {\ttfamily ossl\+\_\+quic\+\_\+fifd\+\_\+pkt\+\_\+commit()}. The FIFD submits the packet to the ACK Manager as a transmitted packet and provides its own callback implementations to the ACK Manager for the packet. Note that the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} is returned to the free pool once any of these callbacks occur; once a packet\textquotesingle{}s fate is known (acked, lost or discarded), use is immediately made of the information in the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} and the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} is immediately released. CFQ items may be freed (on ACK or discard) or transitioned back to the NEW state (on loss).

The FIFD consumes various dependencies so that it can inform the appropriate subsystems in the event of a packet being acked, lost or discarded. In particular\+:


\begin{DoxyItemize}
\item It references a CFQ used to manage CFQ items;
\item It references an ACK manager which it informs of transmitted packets;
\item It references a TXPIM which manages each {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT};
\item It is provided with a callback to obtain a QUIC Send Stream based on a stream ID. Thus the caller of the FIFD may implement whatever strategy it likes to map stream IDs to QUIC Send Stream instances.
\item It is provided with a callback which is called when it thinks a frame should be regenerated using the REGEN strategy. Some of these are specific to a given stream, in which case a stream ID is specified.
\end{DoxyItemize}

All of the state is in the dependencies referenced by the FIFD. The FIFD itself simply glues all of these parts together.\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md405}{}\doxysubsection{\texorpdfstring{API}{API}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md405}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{typedef}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structquic__fifd__st}{quic\_fifd\_st}}\ \{}
\DoxyCodeLine{\ \ \textcolor{comment}{/*\ (internals)\ */}}
\DoxyCodeLine{\}\ \mbox{\hyperlink{structquic__fifd__st}{QUIC\_FIFD}};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ ossl\_quic\_fifd\_init(\mbox{\hyperlink{structquic__fifd__st}{QUIC\_FIFD}}\ *fifd,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structquic__cfq__st}{QUIC\_CFQ}}\ *cfq,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ QUIC\_ACKM\ *ackm,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structquic__txpim__st}{QUIC\_TXPIM}}\ *txpim,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ stream\_id\ is\ UINT64\_MAX\ for\ the\ crypto\ stream\ */}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ OSSL\_QSS\ *(*get\_qss\_by\_id)(uint64\_t\ stream\_id,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ *arg),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ *get\_qss\_by\_id\_arg,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ stream\_id\ is\ UINT64\_MAX\ if\ not\ applicable\ */}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ (*regen\_frame)(uint64\_t\ frame\_type,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ uint64\_t\ stream\_id,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ *arg),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{void}\ *regen\_frame\_arg);}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ossl\_quic\_fifd\_cleanup(\mbox{\hyperlink{structquic__fifd__st}{QUIC\_FIFD}}\ *fifd);\ \textcolor{comment}{/*\ (no-\/op)\ */}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ ossl\_quic\_fifd\_pkt\_commit(\mbox{\hyperlink{structquic__fifd__st}{QUIC\_FIFD}}\ *fifd,\ \mbox{\hyperlink{structquic__txpim__pkt__st}{QUIC\_TXPIM\_PKT}}\ *pkt);}

\end{DoxyCode}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md406}{}\doxysection{\texorpdfstring{Typical Intended TX Packetiser Usage}{Typical Intended TX Packetiser Usage}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-fifm_autotoc_md406}

\begin{DoxyItemize}
\item TX Packetiser maintains flags for each REGEN-\/strategy frame type. It sets this flag when the regenerate callback is issued by the FIFD and clears it when transmitting a packet containing such a frame.
\item TX Packetiser obtains a {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} structure by calling {\ttfamily ossl\+\_\+quic\+\_\+txpim\+\_\+pkt\+\_\+alloc()}.
\item TX Packetiser fills in the ACKM part of the {\ttfamily QUIC\+\_\+\+TXPIM\+\_\+\+PKT} ({\ttfamily QUIC\+\_\+\+ACKM\+\_\+\+TX\+\_\+\+PKT}), except for the callback fields, which are handled by the FIFD.
\item TX Packetiser queries the ACK Manager to determine if an ACK frame is desired, and if so adds it to the packet.
\item TX Packetiser queries the CFQ to determine what control frames it places in a packet. It does this before adding STREAM or CRYPTO frames (i.\+e., all CFQ frames are considered of higher priority). For each such frame it places in a packet, it\+:
\begin{DoxyItemize}
\item calls {\ttfamily ossl\+\_\+quic\+\_\+txpim\+\_\+pkt\+\_\+add\+\_\+cfq\+\_\+item()} on the TXPIM to log the CFQ item as having been transmitted in the given packet, so that the CFQ item can be released or requeued depending on the ultimate fate of the packet.
\end{DoxyItemize}
\item For each STREAM or CRYPTO frame included in a packet, the TX Packetiser\+:
\begin{DoxyItemize}
\item informs the QUIC Send Stream instance for that stream that a range of bytes has been transmitted;
\item also informs the QUIC Send Stream instance if FIN was set on a STREAM frame.
\item calls {\ttfamily ossl\+\_\+quic\+\_\+txpim\+\_\+pkt\+\_\+append\+\_\+chunk()} to log a logical range of the given application or crypto stream as having been sent, so that it can be subsequently marked as acknowledged or lost depending on the ultimate fate of the packet.
\end{DoxyItemize}
\item TX Packetiser calls {\ttfamily ossl\+\_\+quic\+\_\+fifd\+\_\+pkt\+\_\+commit()}. The FIFD takes care of submitting the packet to the ACK Manager and provides its own callback implementation. It also takes care of informing the CFQ that any CFQ items which were added via {\ttfamily ossl\+\_\+quic\+\_\+txpim\+\_\+pkt\+\_\+add\+\_\+cfq\+\_\+item()} have been transmitted.

In the event of packet loss, ACK or discard, the appropriate QUIC Send Stream, CFQ and regenerate callback calls are made. Regardless of the outcome, the TXPIM is released. 
\end{DoxyItemize}