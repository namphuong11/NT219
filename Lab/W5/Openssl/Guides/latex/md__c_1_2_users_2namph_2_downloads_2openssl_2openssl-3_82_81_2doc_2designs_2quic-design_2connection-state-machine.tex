\chapter{QUIC Connection State Machine}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine}{}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine}\index{QUIC Connection State Machine@{QUIC Connection State Machine}}
\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md252}{}\doxysection{\texorpdfstring{FSM Model}{FSM Model}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md252}
QUIC client-\/side connection state can be broken down into five coarse phases of a QUIC connection\+:


\begin{DoxyItemize}
\item The Idle substate (which is simply the state before we have started trying to establish a connection);
\item The Active state, which comprises two substates\+:
\begin{DoxyItemize}
\item The Establishing state, which comprises many different substates;
\item The Open state;
\end{DoxyItemize}
\item The Terminating state, which comprises several substates;
\item The Terminated state, which is the terminal state.
\end{DoxyItemize}

There is monotonic progression through these phases.

These names have been deliberately chosen to use different terminology to common QUIC terms such as \textquotesingle{}handshake\textquotesingle{} to avoid confusion, as they are not the same concepts. For example, the Establishing state uses Initial, Handshake and 1-\/RTT packets.

This discussion is (currently) given from the client side perspective only. State machine considerations only relevant to servers are not mentioned. 0-\/RTT is also not currently modelled in this analysis.

The synthesis of this FSM is not suggested by the QUIC RFCs but has been discerned from the requirements imposed. This does not mean that the implementation of this FSM as literally presented below is an optimal or advisable implementation strategy, and a cursory examination of existing QUIC implementations suggests that such an approach is not common. Moreover, excess attention should not be given to the Open state, as 1-\/RTT application communication can occur even still in the Establishing state (for example, when the handshake has been completed but not yet confirmed).

However, the state machine described herein is helpful as an aid to understanding and broadly captures the logic which our implementation will embody. The design of the actual implementation is discussed further below.

The above states and their substates are defined as follows\+:


\begin{DoxyItemize}
\item The Establishing state involves the use of Initial and Handshake packets. It is terminated when the handshake is confirmed.

Handshake confirmation is not the same as handshake completion. Handshake confirmation occurs on the client when it receives a {\ttfamily HANDSHAKE\+\_\+\+DONE} frame (which occurs in a 1-\/RTT packet, thus 1-\/RTT packets are also invoked in the Establishing state). On the server, handshake confirmation occurs as soon as the handshake is considered completed (see RFC 9001 s. 4.\+1).

The Establishing state is subdivided into the following substates\+:
\begin{DoxyItemize}
\item Proactive Version Negotiation (optional)\+: The client sends a Version Negotiation packet with a reserved version number to forcibly elicit a list of the server\textquotesingle{}s supported versions. This is not expected to be commonly used, as it adds a round trip.

If it is used, the time spent in this state is based on waiting for the server to respond, and potentially retransmitting after a timeout.
\item Pre-\/\+Initial\+: The client has completed proactive version negotiation (if it performed it), but has not yet sent any encrypted packet. This substate is included for exposition; no time will generally be spent in it and there is immediate transmission of the first encrypted packet and transition to Initial Exchange A.
\item Initial Exchange A\+: The client has sent at least one Initial packet to the server attempting to initiate a connection.

The client is waiting for a server response, which might be\+:
\begin{DoxyItemize}
\item a Version Negotiation packet (leading to the Reactive Version Negotiation state);
\item a Retry packet (leading to Initial Exchange B); or
\item an Initial packet (leading to the Initial Exchange Confirmed state).
\end{DoxyItemize}
\item Reactive Version Negotiation\+: The server has rejected the client\textquotesingle{}s proposed version. If proactive version negotiation was used, this can be considered an error. Otherwise, we return to the Pre-\/\+Initial state and proceed as though proactive version negotiation was performed using the information in the version negotiation packet.
\item Initial Exchange B\+: The client has been asked to perform a Retry. It sends at least one Initial packet to the server attempting to initiate a connection. Every Initial packet contains the quoted Retry Token. Any data sent in {\ttfamily CRYPTO} frames in Initial Exchange A must be retransmitted, but PNs MUST NOT be reset. Note that this is still considered part of the same connection, and QUIC Transport Parameters are later used to cryptographically bind the established connection state to the original DCIDs used as part of the Retry process. A server is not allowed to respond to a Retry-\/triggered Initial exchange with another Retry, and if it does we ignore it, which is the major distinction of this state from Initial Exchange A.

The client is waiting for a server response, which might be\+:
\begin{DoxyItemize}
\item a Version Negotiation packet (invalid, ignored);
\item a Retry packet (invalid, ignored);
\item an Initial packet (leading to the Initial Exchange Continued state);
\end{DoxyItemize}
\item Initial Exchange Continued\+: The client has sent at least one Initial packet to the server and received at least one valid Initial packet from the server. There is no longer any possibility of a Retry (any such packet is ignored) and communications may continue via Initial packets for an arbitrarily long period until the handshake layer indicates the Handshake EL is ready.

The client is waiting for server packets, until one of those packets causes the handshake layer (whether it is TLS 1.\+3 or some other hypothetical handshake layer) to emit keys for the Handshake EL. This will generally occur due to incoming Initial packets containing crypto stream segments (in the form of {\ttfamily CRYPTO} frames) which deliver handshake layer protocol messages to the handshake layer in use.
\item Handshake\+: The Handshake EL is now available to the client. Either client or server may send the first Handshake packet.

The client is waiting to receive a Handshake packet from the server.
\item Handshake Continued\+: The client has received and successfully decrypted at least one Handshake packet. The client now discards the Initial EL. Communications via the handshake EL may continue for an arbitrary period of time.

The client is waiting to receive more Handshake packets from the server to advance the handshake layer and cause it to transition to the Handshake Completed state.
\item Handshake Completed\+: The handshake layer has indicated that it considers the handshake completed. For TLS 1.\+3, this means both parties have sent and received (and verified) TLS 1.\+3 Finished messages. The handshake layer must emit keys for the 1-\/RTT EL at this time.

Though the handshake is not yet confirmed, the client can begin sending 1-\/RTT packets.

The QUIC Transport Parameters sent by the peer are now authenticated. (Though the peer\textquotesingle{}s QUIC Transport Parameters may have been received earlier in the handshake process, they are only considered authenticated at this point.)

The client transitions to Handshake Confirmed once either
\begin{DoxyItemize}
\item it receives a {\ttfamily HANDSHAKE\+\_\+\+DONE} frame in a 1-\/RTT packet, or
\item it receives acknowledgement of any 1-\/RTT packet it sent.
\end{DoxyItemize}

Though this discussion only covers the client state machine, it is worth noting that on the server, the handshake is considered confirmed as soon as it is considered completed.
\item Handshake Confirmed\+: The client has received confirmation from the server that the handshake is confirmed.

The principal effect of moving to this state is that the Handshake EL is discarded. Key Update is also now permitted for the first time.

The Establishing state is now done and there is immediate transition to the Open state.
\end{DoxyItemize}
\item The Open state is the steady state of the connection. It is a single state.

Application stream data is exchanged freely. Only 1-\/RTT packets are used. The Initial, Handshake (and 0-\/RTT) ELs have been discarded, transport parameters have been exchanged, and the handshake has been confirmed.

The client transitions to
\begin{DoxyItemize}
\item the Terminating — Closing state if the local application initiates an immediate close (a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is sent);
\item the Terminating — Draining state if the remote peer initiates an immediate close (i.\+e., a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is received);
\item the Terminated state if the idle timeout expires; a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is NOT sent;
\item the Terminated state if the peer triggers a stateless reset; a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is NOT sent.
\end{DoxyItemize}
\item The Terminating state is used when closing the connection. This may occur due to an application request or a transport-\/level protocol error.

Key updates may not be initiated in the Terminating state.

This state is divided into two substates\+:
\begin{DoxyItemize}
\item The Closing state, used for a locally initiated immediate close. In this state, a packet containing a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is transmitted again in response to any packets received. This ensures that a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is received by the peer even if the initially transmitted {\ttfamily CONNECTION\+\_\+\+CLOSE} frame was lost. Note that these {\ttfamily CONNECTION\+\_\+\+CLOSE} frames are not governed by QUIC\textquotesingle{}s normal loss detection mechanisms; this is a bespoke mechanism unique to this state, which exists solely to ensure delivery of the {\ttfamily CONNECTION\+\_\+\+CLOSE} frame.

The endpoint progresses to the Terminated state after a timeout interval, which should not be less than three times the PTO interval.

It is also possible for the endpoint to transition to the Draining state instead, if it receives a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame prior to the timeout expiring. This indicates that the peer is also closing.
\item The Draining state, used for a peer initiated immediate close.

The local endpoint may not send any packets of any kind in this state. It may optionally send one {\ttfamily CONNECTION\+\_\+\+CLOSE} frame immediately prior to entering this state.

The endpoint progresses to the Terminated state after a timeout interval, which should not be less than three times the PTO interval.
\end{DoxyItemize}
\item The Terminated state is the terminal state of a connection. Regardless of how a connection ends (local or peer-\/initiated immediate close, idle timeout, stateless reset), a connection always ultimately ends up in this state. There is no longer any requirement to send or receive any packet. No timer events related to the connection will ever need fire again. This is a totally quiescent state. The state associated with the connection may now be safely freed.
\end{DoxyItemize}

We express this state machine in more concrete form in the form of a table, which makes the available transitions clear\+:

† Except where superseded by a more specific transition

ε means “where no other transition is applicable”.

Where an action is specified in the Transition/\+Action column but no new state, no state change occurs.

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{4}{|X[-1]}|}
\hline
\cellcolor{\tableheadbgcolor}\textbf{ State}&\cellcolor{\tableheadbgcolor}\textbf{ Action On Entry/\+Exit}&\cellcolor{\tableheadbgcolor}\textbf{ Event}&\cellcolor{\tableheadbgcolor}\textbf{ Transition/\+Action }\\\cline{1-4}
\endfirsthead
\hline
\endfoot
\hline
\cellcolor{\tableheadbgcolor}\textbf{ State}&\cellcolor{\tableheadbgcolor}\textbf{ Action On Entry/\+Exit}&\cellcolor{\tableheadbgcolor}\textbf{ Event}&\cellcolor{\tableheadbgcolor}\textbf{ Transition/\+Action }\\\cline{1-4}
\endhead
\multirow{2}{*}{{\ttfamily IDLE} }&\multirow{2}{*}{}&—{\ttfamily APP\+:CONNECT}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+PROACTIVE\+\_\+\+VER\+\_\+\+NEG} (if used), else {\ttfamily ACTIVE.\+ESTABLISHING.\+PRE\+\_\+\+INITIAL}  \\\cline{3-4}
&&—{\ttfamily APP\+:CLOSE}→ &{\ttfamily TERMINATED}  \\\cline{1-4}
\multirow{5}{*}{{\ttfamily ACTIVE} }&\multirow{5}{*}{}&—{\ttfamily IDLE\+\_\+\+TIMEOUT}→ &{\ttfamily TERMINATED}  \\\cline{3-4}
&&—{\ttfamily PROBE\+\_\+\+TIMEOUT}→ † &{\ttfamily Send\+Probe\+If\+Any\+Sent\+Pkts\+Unacked()}  \\\cline{3-4}
&&—{\ttfamily APP\+:CLOSE}→ † &{\ttfamily TERMINATING.\+CLOSING}  \\\cline{3-4}
&&—{\ttfamily RX\+:ANY\mbox{[}CONNECTION\+\_\+\+CLOSE\mbox{]}}→ &{\ttfamily TERMINATING.\+DRAINING}  \\\cline{3-4}
&&—{\ttfamily RX\+:STATELESS\+\_\+\+RESET}→ &{\ttfamily TERMINATED} 

\\\cline{1-4}
\multirow{3}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+PROACTIVE\+\_\+\+VER\+\_\+\+NEG} }&\multirow{3}{*}{{\ttfamily enter\+:Send\+Req\+Ver\+Neg} }&—{\ttfamily RX\+:VER\+\_\+\+NEG}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+PRE\+\_\+\+INITIAL}  \\\cline{3-4}
&&—{\ttfamily PROBE\+\_\+\+TIMEOUT}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+PROACTIVE\+\_\+\+VER\+\_\+\+NEG} (retransmit)  \\\cline{3-4}
&&—{\ttfamily APP\+:CLOSE}→ &{\ttfamily TERMINATED}  \\\cline{1-4}
\multirow{1}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+PRE\+\_\+\+INITIAL} }&\multirow{1}{*}{}&—ε→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+A}  \\\cline{1-4}
\multirow{4}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+A} }&\multirow{4}{*}{{\ttfamily enter\+:Send\+Packets()} (First Initial) }&—{\ttfamily RX\+:RETRY}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+B}  \\\cline{3-4}
&&—{\ttfamily RX\+:INITIAL}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+\+CONTINUED}  \\\cline{3-4}
&&—{\ttfamily RX\+:VER\+\_\+\+NEG}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+REACTIVE\+\_\+\+VER\+\_\+\+NEG}  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{1}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+REACTIVE\+\_\+\+VER\+\_\+\+NEG} }&\multirow{1}{*}{}&—ε→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+PRE\+\_\+\+INITIAL}  \\\cline{1-4}
\multirow{3}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+B} }&\multirow{3}{*}{{\ttfamily enter\+:Send\+Packets()}~\newline
 (First Initial, with token)~\newline
 (\texorpdfstring{$\ast$}{*}\+All further Initial packets contain the token)~\newline
(\texorpdfstring{$\ast$}{*}\+PN is not reset) }&—{\ttfamily RX\+:INITIAL}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+\+CONTINUED}  \\\cline{3-4}
&&—{\ttfamily PROBE\+\_\+\+TIMEOUT}→ &TODO\+: Tail loss probe for initial packets?  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{2}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+\+CONTINUED} }&\multirow{2}{*}{{\ttfamily enter\+:Send\+Packets()} }&—{\ttfamily RX\+:INITIAL}→ &(packet processed, no change)  \\\cline{3-4}
&&—{\ttfamily TLS\+:HAVE\+\_\+\+EL(\+HANDSHAKE)}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE}  \\\cline{1-4}
\multirow{3}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE} }&\multirow{3}{*}{{\ttfamily enter\+:Provision\+EL(\+Handshake)}~\newline
 {\ttfamily enter\+:Send\+Packets()} (First Handshake packet, if pending) }&—{\ttfamily RX\+:HANDSHAKE}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+CONTINUED}  \\\cline{3-4}
&&—{\ttfamily RX\+:INITIAL}→ &(packet processed if EL is not dropped)  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{3}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+CONTINUED} }&\multirow{3}{*}{{\ttfamily enter\+:Drop\+EL(\+Initial)}~\newline
{\ttfamily enter\+:Send\+Packets()} }&—{\ttfamily RX\+:HANDSHAKE}→ &(packet processed, no change)  \\\cline{3-4}
&&—{\ttfamily TLS\+:HANDSHAKE\+\_\+\+COMPLETE}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+COMPLETE}  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{3}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+COMPLETED} }&\multirow{3}{*}{{\ttfamily enter\+:Provision\+EL(1\+RTT)}~\newline
{\ttfamily enter\+:Handshake\+Complete()}~\newline
{\ttfamily enter\mbox{[}server\mbox{]}\+:Send(\+HANDSHAKE\+\_\+\+DONE)}~\newline
{\ttfamily enter\+:Send\+Packets()} }&—{\ttfamily RX\+:1RTT\mbox{[}HANDSHAKE\+\_\+\+DONE\mbox{]}}→ &{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+CONFIRMED}  \\\cline{3-4}
&&—{\ttfamily RX\+:1RTT}→ &(packet processed, no change)  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{1}{*}{{\ttfamily ACTIVE.\+ESTABLISHING.\+HANDSHAKE\+\_\+\+CONFIRMED} }&\multirow{1}{*}{{\ttfamily enter\+:Discard\+EL(\+Handshake)}~\newline
{\ttfamily enter\+:Permit1\+RTTKey\+Update()} }&—ε→ &{\ttfamily ACTIVE.\+OPEN}  \\\cline{1-4}
\multirow{2}{*}{{\ttfamily ACTIVE.\+OPEN} }&\multirow{2}{*}{}&—{\ttfamily RX\+:1RTT}→ &(packet processed, no change)  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{2}{*}{{\ttfamily TERMINATING} }&\multirow{2}{*}{}&—{\ttfamily TERMINATING\+\_\+\+TIMEOUT}→ &{\ttfamily TERMINATED}  \\\cline{3-4}
&&—{\ttfamily RX\+:STATELESS\+\_\+\+RESET}→ &{\ttfamily TERMINATED}  \\\cline{1-4}
\multirow{3}{*}{{\ttfamily TERMINATING.\+CLOSING} }&\multirow{3}{*}{{\ttfamily enter\+:Queue\+Connection\+Close\+Frame()}~\newline
{\ttfamily enter\+:Send\+Packets()} }&—{\ttfamily RX\+:ANY\mbox{[}CONNECTION\+\_\+\+CLOSE\mbox{]}}→ &{\ttfamily TERMINATING.\+DRAINING}  \\\cline{3-4}
&&—{\ttfamily RX\+:ANY}→ &{\ttfamily Queue\+Connection\+Close\+Frame()}~\newline
{\ttfamily Send\+Packets()}  \\\cline{3-4}
&&—{\ttfamily CAN\+\_\+\+SEND}→ &{\ttfamily Send\+Packets()}  \\\cline{1-4}
\multirow{1}{*}{{\ttfamily TERMINATING.\+DRAINING} }&\multirow{1}{*}{}&&\\\cline{1-4}
\multirow{1}{*}{{\ttfamily TERMINATED} }&\multirow{1}{*}{}&\mbox{[}terminal state\mbox{]} &\\\cline{1-4}
\end{longtabu}


Notes on various events\+:


\begin{DoxyItemize}
\item {\ttfamily CAN\+\_\+\+SEND} is raised when transmission of packets has been unblocked after previously having been blocked. There are broadly two reasons why transmission of packets may not have been possible\+:
\begin{DoxyItemize}
\item Due to OS buffers or network-\/side write BIOs being full;
\item Due to limits imposed by the chosen congestion controller.
\end{DoxyItemize}

{\ttfamily CAN\+\_\+\+SEND} is expected to be raised due to a timeout prescribed by the congestion controller or in response to poll(2) or similar notifications, as abstracted by the BIO system and how the application has chosen to notify libssl of network I/O readiness.

It is generally implied that processing of a packet as mentioned above may cause new packets to be queued and sent, so this is not listed explicitly in the Transition column except for the {\ttfamily CAN\+\_\+\+SEND} event.
\item {\ttfamily PROBE\+\_\+\+TIMEOUT} is raised after the PTO interval and stimulates generation of a tail loss probe.
\item {\ttfamily IDLE\+\_\+\+TIMEOUT} is raised after the connection idle timeout expires. Note that the loss detector only makes a determination of loss due to an incoming ACK frame; if a peer becomes totally unresponsive, this is the only mechanism available to terminate the connection (other than the local application choosing to close it).
\item {\ttfamily RX\+:STATELESS\+\_\+\+RESET} indicates receipt of a stateless reset, but note that it is not guaranteed that we are able to recognise a stateless reset that we receive, thus this event may not always be raised.
\item {\ttfamily RX\+:ANY\mbox{[}CONNECTION\+\_\+\+CLOSE\mbox{]}} denotes a {\ttfamily CONNECTION\+\_\+\+CLOSE} frame received in any non-\/discarded EL.
\item Any circumstance where {\ttfamily RX\+:RETRY} or {\ttfamily RX\+:VER\+\_\+\+NEG} are not explicitly listed means that these packets are not allowed and will be ignored.
\item Protocol errors, etc. can be handled identically to {\ttfamily APP\+:CLOSE} events as indicated in the above table if locally initiated. Protocol errors signalled by the peer are handled as {\ttfamily RX\+:ANY\mbox{[}CONNECTION\+\_\+\+CLOSE\mbox{]}} events.
\end{DoxyItemize}

Notes on various actions\+:


\begin{DoxyItemize}
\item {\ttfamily Send\+Packets()} sends packets if we have anything pending for transmission, and only to the extent we are able to with regards to congestion control and available BIO buffer space, etc.
\end{DoxyItemize}\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md253}{}\doxysection{\texorpdfstring{Non-\/\+FSM Model}{Non-\/\+FSM Model}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md253}
Common QUIC implementations appear to prefer modelling connection state as a set of flags rather than as a FSM. It can be observed above that there is a fair degree of commonality between many states. This has been modelled above using hierarchical states with default handlers for common events. \mbox{[}The state machine can be viewed as a diagram here (large image).\mbox{]}(./images/connection-\/state-\/machine.png)

We transpose the above table to sort by events rather than states, to discern the following list of events\+:


\begin{DoxyItemize}
\item {\ttfamily APP\+:CONNECT}\+: Supported in {\ttfamily IDLE} state only.
\item {\ttfamily RX\+:VER\+\_\+\+NEG}\+: Handled in {\ttfamily ESTABLISHING.\+PROACTIVE\+\_\+\+VER\+\_\+\+NEG} and {\ttfamily ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+A} only, otherwise ignored.
\item {\ttfamily RX\+:RETRY}\+: Handled in {\ttfamily ESTABLISHING.\+INITIAL\+\_\+\+EXCHANGE\+\_\+A} only.
\item {\ttfamily PROBE\+\_\+\+TIMEOUT}\+: Applicable to {\ttfamily OPEN} and all (non-\/ε) {\ttfamily ESTABLISHING} substates. Handled via {\ttfamily Send\+Probe\+If\+Any\+Sent\+Pkts\+Unacked()} except in the {\ttfamily ESTABLISHING.\+PROACTIVE\+\_\+\+VER\+\_\+\+NEG} state, which reenters that state to trigger retransmission of a Version Negotiation packet.
\item {\ttfamily IDLE\+\_\+\+TIMEOUT}\+: Applicable to {\ttfamily OPEN} and all (non-\/ε) {\ttfamily ESTABLISHING} substates. Action\+: immediate transition to {\ttfamily TERMINATED} (no {\ttfamily CONNECTION\+\_\+\+CLOSE} frame is sent).
\item {\ttfamily TERMINATING\+\_\+\+TIMEOUT}\+: Timeout used by the {\ttfamily TERMINATING} state only.
\item {\ttfamily CAN\+\_\+\+SEND}\+: Applicable to {\ttfamily OPEN} and all (non-\/ε) {\ttfamily ESTABLISHING} substates, as well as {\ttfamily TERMINATING.\+CLOSING}. Action\+: {\ttfamily Send\+Packets()}.
\item {\ttfamily RX\+:STATELESS\+\_\+\+RESET}\+: Applicable to all {\ttfamily ESTABLISHING} and {\ttfamily OPEN} states and the {\ttfamily TERMINATING.\+CLOSING} substate. Always causes a direct transition to {\ttfamily TERMINATED}.
\item {\ttfamily APP\+:CLOSE}\+: Supported in {\ttfamily IDLE}, {\ttfamily ESTABLISHING} and {\ttfamily OPEN} states. (Reasonably a no-\/op in {\ttfamily TERMINATING} or {\ttfamily TERMINATED.})
\item {\ttfamily RX\+:ANY\mbox{[}CONNECTION\+\_\+\+CLOSE\mbox{]}}\+: Supported in all {\ttfamily ESTABLISHING} and {\ttfamily OPEN} states, as well as in {\ttfamily TERMINATING.\+CLOSING}. Transition to {\ttfamily TERMINATING.\+DRAINING}.
\item {\ttfamily RX\+:INITIAL}, {\ttfamily RX\+:HANDSHAKE}, {\ttfamily RX\+:1RTT}\+: Our willingness to process these is modelled on whether we have an EL provisioned or discarded, etc.; thus this does not require modelling as additional state.

Once we successfully decrypt a Handshake packet, we stop processing Initial packets and discard the Initial EL, as required by RFC.
\item {\ttfamily TLS\+:HAVE\+\_\+\+EL(\+HANDSHAKE)}\+: Emitted by the handshake layer when Handshake EL keys are available.
\item {\ttfamily TLS\+:HANDSHAKE\+\_\+\+COMPLETE}\+: Emitted by the handshake layer when the handshake is complete. Implies connection has been authenticated. Also implies 1-\/RTT EL keys are available. Whether the handshake is complete, and also whether it is confirmed, is reasonably implemented as a flag.
\end{DoxyItemize}

From here we can discern state dependence of different events\+:


\begin{DoxyItemize}
\item {\ttfamily APP\+:CONNECT}\+: Need to know if application has invoked this event yet, as if so it is invalid.

State\+: Boolean\+: Connection initiated?
\item {\ttfamily RX\+:VER\+\_\+\+NEG}\+: Only valid if we have not yet received any successfully processed encrypted packet from the server.
\item {\ttfamily RX\+:RETRY}\+: Only valid if we have sent an Initial packet to the server, have not yet received any successfully processed encrypted packet from the server, and have not previously been asked to do a Retry as part of this connection (and the Retry Integrity Token validates).

Action\+: Note that we are now acting on a retry and start again. Do not reset packet numbers. The original CIDs used for the first connection attempt must be noted for later authentication in the QUIC Transport Parameters.

State\+: Boolean\+: Retry requested?

State\+: CID\+: Original SCID, DCID.
\item {\ttfamily PROBE\+\_\+\+TIMEOUT}\+: If we have sent at least one encrypted packet yet, we can handle this via a standard probe-\/sending mechanism. Otherwise, we are still in Proactive Version Negotiation and should retransmit the Version Negotiation packet we sent.

State\+: Boolean\+: Doing proactive version negotiation?
\item {\ttfamily IDLE\+\_\+\+TIMEOUT}\+: Only applicable in {\ttfamily ACTIVE} states.

We are {\ttfamily ACTIVE} if a connection has been initiated (see {\ttfamily APP\+:CONNECT}) and we are not in {\ttfamily TERMINATING} or {\ttfamily TERMINATED}.
\item {\ttfamily TERMINATING\+\_\+\+TIMEOUT}\+: Timer used in {\ttfamily TERMINATING} state only.
\item {\ttfamily CAN\+\_\+\+SEND}\+: Stimulates transmission of packets.
\item {\ttfamily RX\+:STATELESS\+\_\+\+RESET}\+: Always handled unless we are in {\ttfamily TERMINATED}.
\item {\ttfamily APP\+:CLOSE}\+: Usually causes a transition to {\ttfamily TERMINATING.\+CLOSING}.
\item {\ttfamily RX\+:INITIAL}, {\ttfamily RX\+:HANDSHAKE}, {\ttfamily RX\+:1RTT}\+: Willingness to process these is implicit in whether we currently have the applicable EL provisioned.
\item {\ttfamily TLS\+:HAVE\+\_\+\+EL(\+HANDSHAKE)}\+: Handled by the handshake layer and forwarded to the record layer to provision keys.
\item {\ttfamily TLS\+:HANDSHAKE\+\_\+\+COMPLETE}\+: Should be noted as a flag and notification provided to various components.
\end{DoxyItemize}

We choose to model the CSM\textquotesingle{}s state as follows\+:


\begin{DoxyItemize}
\item The {\ttfamily IDLE}, {\ttfamily ACTIVE}, {\ttfamily TERMINATING.\+CLOSED}, {\ttfamily TERMINATING.\+DRAINED} and {\ttfamily TERMINATED} states are modelled explicitly as a state variable. However, the substates of {\ttfamily ACTIVE} are not explicitly modelled.
\item The following flags are modelled\+:
\begin{DoxyItemize}
\item Retry Requested? (+ Original SCID, DCID if so)
\item Have Sent Any Packet?
\item Are we currently doing proactive version negotiation?
\item Have Successfully Received Any Encrypted Packet?
\item Handshake Completed?
\item Handshake Confirmed?
\end{DoxyItemize}
\item The following timers are modelled\+:
\begin{DoxyItemize}
\item PTO Timeout
\item Terminating Timeout
\item Idle Timeout
\end{DoxyItemize}
\end{DoxyItemize}\hypertarget{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md254}{}\doxysection{\texorpdfstring{Implementation Plan}{Implementation Plan}}\label{md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2connection-state-machine_autotoc_md254}

\begin{DoxyItemize}
\item Phase 1\+: “\+Steady state only” model which jumps to the {\ttfamily ACTIVE.\+OPEN} state with a hardcoded key.

Test plan\+: Currently uncertain, to be determined.
\item Phase 2\+: “\+Dummy handshake” model which uses a one-\/byte protocol as the handshake layer as a standin for TLS 1.\+3. e.\+g. a 0x01 byte “represents” a Client\+Hello, a 0x02 byte “represents” a Server\+Hello. Keys are fixed.

Test plan\+: If feasible, an existing QUIC implementation will be modified to use this protocol and E2E testing will be performed against it. (This can probably be done quickly but an alternate plan may be required if the effort needed turns out be excessive.)
\item Phase 3\+: Final model with TLS 1.\+3 handshake layer fully plumbed in.

Test plan\+: Testing against real world implementations. 
\end{DoxyItemize}