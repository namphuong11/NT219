<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl Guides: Passing AlgorithmIdentifier parameters to operations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Openssl Guides
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Passing AlgorithmIdentifier parameters to operations</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md230"></a>
Quick background</h1>
<p>We currently only support passing the AlgorithmIdentifier (<code>X509_ALGOR</code>) parameter field to symmetric cipher provider implementations.</p>
<p>We do support passing them to legacy implementations of other types of operation algorithms as well, but it's done in a way that can't be supported with providers, because it involves sharing specific structures between libcrypto and the backend implementation.</p>
<p>For a longer background and explanation, see Background / tl;dr at the end of this design.</p>
<h1><a class="anchor" id="autotoc_md231"></a>
Establish an OSSL_PARAM key that any algorithms may become aware of</h1>
<p>We already have a parameter key, but it's currently only specified for <code>EVP_CIPHER</code>, in support of <code>EVP_CIPHER_param_to_asn1()</code> and <code>EVP_CIPHER_asn1_to_param()</code>.</p>
<p>"alg_id_param", also known as the macro <code>OSSL_CIPHER_PARAM_ALGORITHM_ID_PARAMS</code></p>
<p>This parameter can be used in the exact same manner with other operations, with the value of the AlgorithmIdentifier parameter as an octet string, to be interpreted by the implementations in whatever way they see fit.</p>
<p>Applications can choose to add these in an <code>OSSL_PARAM</code> array, to be passed with the multitude of initialization functions that take such an array, or using specific operation <code>OSSL_PARAM</code> setters and getters (such as <code>EVP_PKEY_CTX_set_params</code>), or using other available convenience functions (see below).</p>
<p>This parameter will have to be documented in the following files:</p>
<ul>
<li><code>doc/man7/provider-asym_cipher.pod</code></li>
<li><code>doc/man7/provider-cipher.pod</code></li>
<li><code>doc/man7/provider-digest.pod</code></li>
<li><code>doc/man7/provider-kdf.pod</code></li>
<li><code>doc/man7/provider-kem.pod</code></li>
<li><code>doc/man7/provider-keyexch.pod</code></li>
<li><code>doc/man7/provider-mac.pod</code></li>
<li><code>doc/man7/provider-signature.pod</code></li>
</ul>
<p>That should cover all algorithms that are, or should be possible to fetch by AlgorithmIdentifier.algorithm, and for which there's potentially a relevant AlgorithmIdentifier.parameters field.</p>
<p>We may arguably want to consider <code>doc/man7/provider-keymgmt.pod</code> too, but an AlgorithmIdentifier that's attached directly to a key is usually part of a PrivKeyInfo or SubjectPublicKeyInfo structure, and those are handled by encoders and decoders as those see fit, and there's no tangible reason why that would have to change.</p>
<h1><a class="anchor" id="autotoc_md232"></a>
Public convenience API</h1>
<p>For convenience, the following set of functions would be added to pass the AlgorithmIdentifier parameter data to diverse operations, or to retrieve such parameter data from them.</p>
<div class="fragment"><div class="line"> C</div>
<div class="line">/*</div>
<div class="line"> * These two would essentially be aliases for EVP_CIPHER_param_to_asn1()</div>
<div class="line"> * and EVP_CIPHER_asn1_to_param().</div>
<div class="line"> */</div>
<div class="line">EVP_CIPHER_CTX_set_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line">EVP_CIPHER_CTX_get_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line"> </div>
<div class="line">EVP_MD_CTX_set_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line">EVP_MD_CTX_get_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line"> </div>
<div class="line">EVP_MAC_CTX_set_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line">EVP_MAC_CTX_get_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line"> </div>
<div class="line">EVP_KDF_CTX_set_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line">EVP_KDF_CTX_get_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line"> </div>
<div class="line">EVP_PKEY_CTX_set_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
<div class="line">EVP_PKEY_CTX_get_algor_param(EVP_PKEY_CTX *ctx, X509_ALGOR *alg);</div>
</div><!-- fragment --><p>Note that all might not need to be added immediately, depending on if they are considered useful or not. For future proofing, however, they should probably all be added.</p>
<h1><a class="anchor" id="autotoc_md233"></a>
Requirements on the providers</h1>
<p>Providers that implement ciphers or any operation that uses asymmetric keys will have to implement support for passing AlgorithmIdentifier parameter data, and will have to process that data in whatever manner that's necessary to meet the standards for that operation.</p>
<h1><a class="anchor" id="autotoc_md234"></a>
Fallback strategies</h1>
<p>There are no possible fallback strategies, which is fine, considering that current provider functionality doesn't support passing AlgorithmIdentifier parameter data at all (except for <code>EVP_CIPHER</code>), and therefore do not work at all when such parameter data needs to be passed.</p>
<hr  />
<hr  />
<h1><a class="anchor" id="autotoc_md237"></a>
Background / tl;dr</h1>
<h2><a class="anchor" id="autotoc_md238"></a>
AlgorithmIdenfier parameter and how it's used</h2>
<p>OpenSSL has historically done a few tricks to not have to pass AlgorithmIdenfier parameter data to the backend implementations of cryptographic operations:</p>
<ul>
<li>In some cases, they were passed as part of the lower level key structure (for example, the <code>RSA</code> structure can also carry RSA-PSS parameters).</li>
<li>In the <code>EVP_CIPHER</code> case, there is functionality to pass the parameter data specifically.</li>
<li>For asymmetric key operations, PKCS#7 and CMS support was added as <code>EVP_PKEY</code> ctrls.</li>
</ul>
<p>With providers, some of that support was retained, but not others. Most crucially, the <code>EVP_PKEY</code> ctrls for PKCS#7 and CMS were not retained, because the way they were implemented violated the principle that provider implementations <em>MUST NOT</em> share complex OpenSSL specific structures with libcrypto.</p>
<h2><a class="anchor" id="autotoc_md239"></a>
Usage examples</h2>
<p>Quite a lot of the available examples today revolve around CMS, with a number of RFCs that specify what parameters should be passed with certain operations / algorithms. This list is not exhaustive, the reader is encouraged to research further usages.</p>
<ul>
<li><a href="https://www.rfc-editor.org/rfc/rfc3370#section-3.1">DSA</a> signatures typically have the domain parameters <em>p</em>, <em>q</em> and <em>g</em>.</li>
<li><a href="https://www.rfc-editor.org/rfc/rfc3370#section-4.3.2">RC2 key wrap</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc3370#section-4.4.1">PBKDF2</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc3370#section-5.1">3DES-CBC</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc3370#section-5.2">RC2-CBC</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc4490.html#section-5.1">GOST 28147-89</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc8017#appendix-A.2.1">RSA-OAEP</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc8017#appendix-A.2.3">RSA-PSS</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc6210.html">XOR-MD5</a> is experimental, but it does demonstrate the possibility of a parametrized hash algorithm.</li>
</ul>
<p>Some of it can be claimed to already have support in OpenSSL. However, this is with old libcrypto code that has special knowledge of the algorithms that are involved. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
