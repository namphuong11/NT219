<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl Guides: QUIC Connection ID Cache</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Openssl Guides
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">QUIC Connection ID Cache</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The connection ID cache is responsible for managing connection IDs, both local and remote.</p>
<h1><a class="anchor" id="autotoc_md240"></a>
Remote Connection IDs</h1>
<p>For remote connection IDs, we need to be able to:</p>
<ul>
<li>add new IDs per connection;</li>
<li>pick a non-retired ID associated from those available for a connection and</li>
<li>select a connection ID by sequence number and retire that and all older IDs.</li>
</ul>
<p>The cache will be implemented as a double ended queue as part of the QUIC_CONNECTION object. The queue will be sorted by sequence number and must maintain a count of the number of connection IDs present. There is no requirement to maintain a global mapping since remote IDs are only used when sending packets, not receiving them.</p>
<p>In MVP, a many-to-1 matching of Connection IDs per Connection object is required. Refer third paragraph in <a href="(https://datatracker.ietf.org/doc/html/rfc9000#section-5.1)">5.1</a>.</p>
<p>When picking a non-retired connection ID for MVP, the youngest available will be chosen.</p>
<h1><a class="anchor" id="autotoc_md241"></a>
Local Connection IDs</h1>
<p>For local connection IDs, we need to be able to:</p>
<ul>
<li>generate a new connection ID and associate it with a connection;</li>
<li>query if a connection ID is present;</li>
<li>for a server, map a connection ID to a QUIC_CONNECTION;</li>
<li>drop all connection IDs associated with a QUIC_CONNECTION;</li>
<li>select a connection ID by sequence number and retire that and all older IDs and</li>
<li>select a connection ID by sequence number and drop that and all older IDs.</li>
</ul>
<p>All connection IDs issued by our stack must be the same length because short form packets include the connection ID but no length byte. Random connection IDs of this length will be allocated. Note that no additional information will be contained in the connection ID.</p>
<p>There will be one global set of local connection IDs, <code>QUIC_ROUTE_TABLE</code>, which is shared by all connections over all SSL_CTX objects. This is used to dispatch incoming datagrams to their correct destination and will be implemented as a dictionary.</p>
<h2><a class="anchor" id="autotoc_md242"></a>
Notes</h2>
<ul>
<li>For MVP, it would be sufficient to only use a zero length connection ID.</li>
<li>For MVP, a connection ID to QUIC_CONNECTION mapping need not be implemented.</li>
<li>Post MVP, funnelling all received packets through a single socket is likely to be bottleneck. An alternative would be receiving from &lt;host address, source port&gt; pairs.</li>
<li>For MVP, the local connection ID cache need only have one element. I.e. there is no requirement to implement any form of lookup.</li>
</ul>
<h1><a class="anchor" id="autotoc_md243"></a>
Routes</h1>
<p>A pair of connection IDs identify a route between the two ends of the communication. This contains the connection IDs of both ends of the connection and the common sequence number. We need to be able to:</p>
<ul>
<li>select a connection ID by sequence number and retire that and all older IDs and</li>
<li>select a connection ID by sequence number and drop that and all older IDs.</li>
</ul>
<p>It is likely that operations on local and remote connection IDs can be subsumed by the route functionality.</p>
<h1><a class="anchor" id="autotoc_md244"></a>
ID Retirement</h1>
<p>Connection IDs are retired by either a <a href="(https://datatracker.ietf.org/doc/html/rfc9000#section-19.15)">NEW_CONNECTION_ID</a> or a <a href="(https://datatracker.ietf.org/doc/html/rfc9000#section-19.16)">RETIRE_CONNECTION_ID</a> frame and this is acknowledged by a RETIRE_CONNECTION_ID or a NEW_CONNECTION_ID frame respectively.</p>
<p>When a retirement frame is received, we can immediately <em>remove</em> the IDs covered from our cache and then send back an acknowledgement of the retirement.</p>
<p>If we want to retire a frame, we send a retirement frame and mark the IDs covered in our cache as <em>retired</em>. This means that we cannot send using any of these IDs but can still receive using them. Once our peer acknowledges the retirement, we can <em>remove</em> the IDs.</p>
<p>It is possible to receive out of order packets <b>after</b> receiving a retirement notification. It's unclear what to do with these, however dropping them seems reasonable. The alternative would be to maintain the route in a <em>deletable</em> state until all packets in flight at the time of retirement have been acked.</p>
<h1><a class="anchor" id="autotoc_md245"></a>
API</h1>
<p>QUIC connection IDs are defined in #18949 but some extra functions are available:</p>
<div class="fragment"><div class="line"><span class="comment">/* QUIC connection ID representation. */</span></div>
<div class="line"><span class="preprocessor">#define QUIC_MAX_CONN_ID_LEN   20</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structquic__conn__id__st.html">quic_conn_id_st</a> {</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> id_len;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <span class="keywordtype">id</span>[QUIC_MAX_CONN_ID_LEN];</div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    <span class="comment">/* likely required later, although this might not be the ideal location */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> reset_token[16];  <span class="comment">/* stateless reset token is per conn ID */</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">} <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ossl_unused ossl_inline <span class="keywordtype">int</span> ossl_quic_conn_id_eq(<span class="keyword">const</span> <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> *a,</div>
<div class="line">                                                        <span class="keyword">const</span> <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> *<a class="code hl_struct" href="structb.html">b</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* New functions */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_conn_id_set(<a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> *cid, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>,</div>
<div class="line">                          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> id_len);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_conn_id_generate(<a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> *cid);</div>
<div class="ttc" id="astructb_html"><div class="ttname"><a href="structb.html">b</a></div><div class="ttdef"><b>Definition</b> check-format-test-negatives.c:375</div></div>
<div class="ttc" id="astructquic__conn__id__st_html"><div class="ttname"><a href="structquic__conn__id__st.html">quic_conn_id_st</a></div><div class="ttdef"><b>Definition</b> quic_types.h:77</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md246"></a>
Remote Connection ID APIs</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>quic_remote_conn_id_cache_st QUIC_REMOTE_CONN_ID_CACHE;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Allocate and free a remote connection ID cache</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">QUIC_REMOTE_CONN_ID_CACHE *ossl_quic_remote_conn_id_cache_new(</div>
<div class="line">        <span class="keywordtype">size_t</span> id_limit   <span class="comment">/* [active_connection_id_limit] */</span></div>
<div class="line">    );</div>
<div class="line"><span class="keywordtype">void</span> ossl_quic_remote_conn_id_cache_free(QUIC_REMOTE_CONN_ID_CACHE *cache);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Add a remote connection ID to the cache</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_remote_conn_id_cache_add(QUIC_REMOTE_CONN_ID_CACHE *cache,</div>
<div class="line">                                       <span class="keyword">const</span> <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn,</div>
<div class="line">                                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *conn_id,</div>
<div class="line">                                       <span class="keywordtype">size_t</span> conn_id_len,</div>
<div class="line">                                       uint64_t seq_no);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Query a remote connection for a connection ID.</span></div>
<div class="line"><span class="comment"> * Each connection can have multiple connection IDs associated with different</span></div>
<div class="line"><span class="comment"> * routes.  This function returns one of these in a non-specified manner.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_remote_conn_id_cache_get0_conn_id(</div>
<div class="line">        <span class="keyword">const</span> QUIC_REMOTE_CONN_ID_CACHE *cache,</div>
<div class="line">        <span class="keyword">const</span> <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn, <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> **cid);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Retire remote connection IDs up to and including the one determined by the</span></div>
<div class="line"><span class="comment"> * sequence number.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_remote_conn_id_cache_retire(</div>
<div class="line">        QUIC_REMOTE_CONN_ID_CACHE *cache, uint64_t seq_no);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove remote connection IDs up to and including the one determined by the</span></div>
<div class="line"><span class="comment"> * sequence number.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_remote_conn_id_cache_remove(</div>
<div class="line">        QUIC_REMOTE_CONN_ID_CACHE *cache, uint64_t seq_no);</div>
<div class="ttc" id="astructquic__conn__st_html"><div class="ttname"><a href="structquic__conn__st.html">quic_conn_st</a></div><div class="ttdef"><b>Definition</b> quic_local.h:109</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md247"></a>
Local Connection ID APIs</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>quic_local_conn_id_cache_st QUIC_LOCAL_CONN_ID_CACHE;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Allocate and free a local connection ID cache</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">QUIC_LOCAL_CONN_ID_CACHE *ossl_quic_local_conn_id_cache_new(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> ossl_quic_local_conn_id_cache_free(QUIC_LOCAL_CONN_ID_CACHE *cache);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Generate a new random local connection ID and associate it with a connection.</span></div>
<div class="line"><span class="comment"> * For MVP this could just be a zero length ID.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_local_conn_id_cache_new_conn_id(QUIC_LOCAL_CONN_ID_CACHE *cache,</div>
<div class="line">                                              <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn,</div>
<div class="line">                                              <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a> **cid);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove a local connection and all associated cached IDs</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_local_conn_id_cache_remove_conn(QUIC_LOCAL_CONN_ID_CACHE *cache,</div>
<div class="line">                                              <span class="keyword">const</span> <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Lookup a local connection by ID.</span></div>
<div class="line"><span class="comment"> * Returns the connection or NULL if absent.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *ossl_quic_local_conn_id_cache_get0_conn(</div>
<div class="line">        <span class="keyword">const</span> QUIC_LOCAL_CONN_ID_CACHE *cache,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *conn_id, <span class="keywordtype">size_t</span> conn_id_len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Retire local connection IDs up to and including the one specified by the</span></div>
<div class="line"><span class="comment"> * sequence number.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_local_conn_id_cache_retire(</div>
<div class="line">        QUIC_LOCAL_CONN_ID_CACHE *cache, uint64_t from_seq_no);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Remove local connection IDs up to and including the one specified by the</span></div>
<div class="line"><span class="comment"> * sequence number.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_local_conn_id_cache_remove(</div>
<div class="line">        QUIC_LOCAL_CONN_ID_CACHE *cache, uint64_t from_seq_no);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md248"></a>
Routes</h2>
<p>Additional status and source information is also included.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>quic_route_st QUIC_ROUTE;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>quic_route_table QUIC_ROUTE_TABLE;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>quic_route_st {</div>
<div class="line">    <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn;</div>
<div class="line">    <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a>     local;</div>
<div class="line">    <a class="code hl_struct" href="structquic__conn__id__st.html">QUIC_CONN_ID</a>     remote;</div>
<div class="line">    uint64_t         seq_no;        <span class="comment">/* Sequence number for both ends */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>     retired : 1;   <span class="comment">/* Connection ID has been retired */</span></div>
<div class="line"><span class="preprocessor">#if 0</span></div>
<div class="line">    <span class="comment">/* Later will require */</span></div>
<div class="line">    BIO_ADDR         remote_address;<span class="comment">/* remote source address */</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">QUIC_ROUTE_TABLE *ossl_quic_route_table_new(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> ossl_quic_route_table_free(QUIC_ROUTE_TABLE *routes);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md249"></a>
Add route to route table</h2>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_route_table_add_route(QUIC_ROUTE_TABLE *cache,</div>
<div class="line">                               QUIC_ROUTE_TABLE *route);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md250"></a>
Route query</h2>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Query a route table entry by either local or remote ID</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line">QUIC_ROUTE *ossl_route_table_get0_route_from_local(</div>
<div class="line">        <span class="keyword">const</span> QUIC_ROUTE_TABLE *cache,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *conn_id, <span class="keywordtype">size_t</span> conn_id_len);</div>
<div class="line">QUIC_ROUTE *ossl_route_table_get0_route_from_remote(</div>
<div class="line">        <span class="keyword">const</span> QUIC_ROUTE_TABLE *cache,</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *conn_id, <span class="keywordtype">size_t</span> conn_id_len);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md251"></a>
Route retirement</h2>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Retire by sequence number up to and including the one specified.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_route_table_retire(QUIC_ROUTE_TABLE *routes,</div>
<div class="line">                                 <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn,</div>
<div class="line">                                 uint64_t seq_no);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Delete by sequence number up to and including the one specified.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> ossl_quic_route_table_remove(QUIC_ROUTE_TABLE *routes,</div>
<div class="line">                                 <a class="code hl_struct" href="structquic__conn__st.html">QUIC_CONNECTION</a> *conn,</div>
<div class="line">                                 uint64_t seq_no);</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
