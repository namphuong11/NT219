<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl Guides: QUIC ACK Manager</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Openssl Guides
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">QUIC ACK Manager</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="images/ackm.png" alt="(Overview block diagram.)" title="QUIC ACK Manager Block Diagram" class="inline"/></p>
<p>The QUIC ACK manager is responsible for, on the TX side:</p>
<ul>
<li>Handling received ACK frames</li>
<li>Generating notifications that a packet we sent was delivered successfully</li>
<li>Generating notifications that a packet we sent was lost</li>
<li>Generating requests for probe transmission</li>
<li>Providing information on the largest unacked packet number so that packet numbers in packet headers can be encoded and decoded correctly</li>
</ul>
<p>On the RX side, it is responsible for:</p>
<ul>
<li>Generating ACK frames for later transmission in response to packets we received</li>
<li>Providing information on whether a given RX packet number is potentially duplicate and should not be processed</li>
</ul>
<p>In order to allow it to perform these tasks, the ACK manager must:</p>
<ul>
<li>be notified of all transmitted packets</li>
<li>be notified of all received datagrams</li>
<li>be notified of all received packets</li>
<li>be notified of all received ACK frames</li>
<li>be notified when a packet number space is discarded</li>
<li>be notified when its loss detection deadline arrives</li>
</ul>
<p>The ACK manager consumes:</p>
<ul>
<li>an arbitrary function which returns the current time;</li>
<li>a RTT statistics tracker;</li>
<li>a congestion controller.</li>
</ul>
<p>The ACK manager provides the following outputs:</p>
<ul>
<li>It indicates the current deadline by which the loss detection event should be invoked.</li>
<li>It indicates when probes should be generated.</li>
<li>It indicates what ACK frames should be generated.</li>
<li>It indicates the current deadline by which new ACK frames will be generated, if any.</li>
<li>It indicates the largest unacknowledged packet number for a given packet number space.</li>
<li>It calls a callback for each transmitted packet it is notified of, specifying whether the packet was successfully acknowledged by the peer, lost or discarded.</li>
<li>It may communicate with a congestion controller, causing the congestion controller to update its state.</li>
<li>It may communicate with a RTT statistics tracker, causing it to update its state.</li>
</ul>
<p>In this document, “the caller” refers to the system which makes use of the ACK manager.</p>
<h1><a class="anchor" id="autotoc_md277"></a>
Utility Definitions</h1>
<p>There are three QUIC packet number spaces: Initial, Handshake and Application Data.</p>
<div class="fragment"><div class="line"><span class="comment">/* QUIC packet number spaces. */</span></div>
<div class="line"><span class="preprocessor">#define QUIC_PN_SPACE_INITIAL       0</span></div>
<div class="line"><span class="preprocessor">#define QUIC_PN_SPACE_HANDSHAKE     1</span></div>
<div class="line"><span class="preprocessor">#define QUIC_PN_SPACE_APP           2</span></div>
<div class="line"><span class="preprocessor">#define QUIC_PN_SPACE_NUM           3</span></div>
</div><!-- fragment --><p>Packet numbers are 62-bit values represented herein by <code>QUIC_PN</code>. <code>QUIC_PN_INFINITE</code> evaluates to an invalid QUIC packet number value.</p>
<div class="fragment"><div class="line"><span class="comment">/* QUIC packet number representation. */</span></div>
<div class="line"><span class="keyword">typedef</span> uint64_t QUIC_PN;</div>
<div class="line"><span class="preprocessor">#define QUIC_PN_INFINITE            UINT64_MAX</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md278"></a>
Instantiation</h1>
<p>The QUIC ACK manager is instantiated as follows:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structossl__ackm__st.html">ossl_ackm_st</a> <a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a>;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ossl_ackm_new(<a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> (*now)(<span class="keywordtype">void</span> *arg),</div>
<div class="line">                         <span class="keywordtype">void</span> *now_arg,</div>
<div class="line">                         QUIC_STATM *statm,</div>
<div class="line">                         <a class="code hl_struct" href="structossl__cc__method__st.html">OSSL_CC_METHOD</a> *cc_method,</div>
<div class="line">                         OSSL_CC_DATA *cc_data);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ossl_ackm_free(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm);</div>
<div class="ttc" id="astruct_o_s_s_l___t_i_m_e_html"><div class="ttname"><a href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a></div><div class="ttdef"><b>Definition</b> time.h:25</div></div>
<div class="ttc" id="astructossl__ackm__st_html"><div class="ttname"><a href="structossl__ackm__st.html">ossl_ackm_st</a></div><div class="ttdef"><b>Definition</b> quic_ackm.c:494</div></div>
<div class="ttc" id="astructossl__cc__method__st_html"><div class="ttname"><a href="structossl__cc__method__st.html">ossl_cc_method_st</a></div><div class="ttdef"><b>Definition</b> quic_cc.h:83</div></div>
</div><!-- fragment --><p>The function pointer <code>now</code> is invoked by the ACK manager to obtain the current time. <code>now_arg</code> is passed as the argument. The congestion controller method and instance passed are used by the ACK manager instance. <code>statm</code> points to a <a class="el" href="md__c_1_2_users_2namph_2_downloads_2openssl_2openssl-3_82_81_2doc_2designs_2quic-design_2quic-statm.html">Statistics Manager tracker instance</a>.</p>
<h1><a class="anchor" id="autotoc_md279"></a>
Events</h1>
<p>The ACK manager state is evolved in response to events provided to the ACK manager by the caller.</p>
<h2><a class="anchor" id="autotoc_md280"></a>
On TX Packet</h2>
<p>This must be called when a packet is transmitted. It does not provide the payload of the packet, but provides metadata about the packet which is relevant to the loss detection and acknowledgement process.</p>
<p>The caller is responsible for the allocation of the structure and the structure must remain allocated until one of the callbacks is called or the ACK manager is freed. It is expected this structure will usually be freed (or returned to a pool) in the implementation of either callback passed by the caller.</p>
<p>Only exactly one of the callbacks in the structure will be called over the lifetime of a <code>OSSL_ACKM_TX_PKT</code>, and only once.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structossl__ackm__tx__pkt__st.html">ossl_ackm_tx_pkt_st</a> {</div>
<div class="line">    <span class="comment">/* The packet number of the transmitted packet. */</span></div>
<div class="line">    QUIC_PN pkt_num;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* The number of bytes in the packet which was sent. */</span></div>
<div class="line">    <span class="keywordtype">size_t</span> num_bytes;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* The time at which the packet was sent. */</span></div>
<div class="line">    <a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> time;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * If the packet being described by this structure contains an ACK frame,</span></div>
<div class="line"><span class="comment">     * this must be set to the largest PN ACK&#39;d by that frame.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * Otherwise, it should be set to QUIC_PN_INVALID.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * This is necessary to bound the number of PNs we have to keep track of on</span></div>
<div class="line"><span class="comment">     * the RX side (RFC 9000 s. 13.2.4). It allows older PN tracking information</span></div>
<div class="line"><span class="comment">     * on the RX side to be discarded.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    QUIC_PN largest_acked;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * One of the QUIC_PN_SPACE_* values. This qualifies the pkt_num field</span></div>
<div class="line"><span class="comment">     * into a packet number space.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pkt_space :2;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* 1 if the packet is in flight. */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is_inflight :1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* 1 if the packet has one or more ACK-eliciting frames. */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is_ack_eliciting :1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* 1 if the packet is a PTO probe. */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is_pto_probe :1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* 1 if the packet is an MTU probe. */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is_mtu_probe :1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Callback called if frames in this packet are lost. arg is cb_arg. */</span></div>
<div class="line">    void (*on_lost)(<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Callback called if frames in this packet are acked. arg is cb_arg. */</span></div>
<div class="line">    void (*on_acked)(<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Callback called if frames in this packet are neither acked nor lost. arg</span></div>
<div class="line"><span class="comment">     * is cb_arg.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    void (*on_discarded)(<span class="keywordtype">void</span> *arg);</div>
<div class="line">    <span class="keywordtype">void</span>  *cb_arg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* (Internal use fields are appended here and must be zero-initialized.) */</span></div>
<div class="line">} <a class="code hl_struct" href="structossl__ackm__tx__pkt__st.html">OSSL_ACKM_TX_PKT</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ossl_ackm_on_tx_packet(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keyword">const</span> <a class="code hl_struct" href="structossl__ackm__tx__pkt__st.html">OSSL_ACKM_TX_PKT</a> *pkt);</div>
<div class="ttc" id="astructossl__ackm__tx__pkt__st_html"><div class="ttname"><a href="structossl__ackm__tx__pkt__st.html">ossl_ackm_tx_pkt_st</a></div><div class="ttdef"><b>Definition</b> quic_ackm.h:59</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md281"></a>
On RX Datagram</h2>
<p>This must be called whenever a datagram is received. A datagram may contain multiple packets, and this function should be called before the calls to <code>ossl_ackm_on_rx_packet</code>.</p>
<p>The primary use of this function is to inform the ACK manager of new credit to the anti-amplification budget. Packet and ACK-frame related logic are handled separately in the subsequent calls to <code>ossl_ackm_on_rx_packet</code> and <code>ossl_ackm_on_rx_ack_frame</code>, respectively.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_on_rx_datagram(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">size_t</span> num_bytes);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md282"></a>
On RX Packet</h2>
<p>This must be called whenever a packet is received. It should be called after <code>ossl_ackm_on_rx_datagram</code> was called for the datagram containing the packet.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define OSSL_ACKM_ECN_NONE      0</span></div>
<div class="line"><span class="preprocessor">#define OSSL_ACKM_ECN_ECT1      1</span></div>
<div class="line"><span class="preprocessor">#define OSSL_ACKM_ECN_ECT0      2</span></div>
<div class="line"><span class="preprocessor">#define OSSL_ACKM_ECN_ECNCE     3</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structossl__ackm__rx__pkt__st.html">ossl_ackm_rx_pkt_st</a> {</div>
<div class="line">    <span class="comment">/* The packet number of the received packet. */</span></div>
<div class="line">    QUIC_PN pkt_num;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* The time at which the packet was received. */</span></div>
<div class="line">    <a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> time;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * One of the QUIC_PN_SPACE_* values. This qualifies the pkt_num field</span></div>
<div class="line"><span class="comment">     * into a packet number space.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pkt_space :2;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* 1 if the packet has one or more ACK-eliciting frames. */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> is_ack_eliciting :1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * One of the OSSL_ACKM_ECN_* values. This is the ECN labelling applied</span></div>
<div class="line"><span class="comment">     * to the received packet. If unknown, use OSSL_ACKM_ECN_NONE.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ecn :2;</div>
<div class="line">} <a class="code hl_struct" href="structossl__ackm__rx__pkt__st.html">OSSL_ACKM_RX_PKT</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ossl_ackm_on_rx_packet(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keyword">const</span> <a class="code hl_struct" href="structossl__ackm__rx__pkt__st.html">OSSL_ACKM_RX_PKT</a> *pkt);</div>
<div class="ttc" id="astructossl__ackm__rx__pkt__st_html"><div class="ttname"><a href="structossl__ackm__rx__pkt__st.html">ossl_ackm_rx_pkt_st</a></div><div class="ttdef"><b>Definition</b> quic_ackm.h:140</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md283"></a>
On RX ACK Frame</h2>
<p>This must be called whenever an ACK frame is received. It should be called after any call to <code>ossl_ackm_on_rx_packet</code>.</p>
<p>The ranges of packet numbers being acknowledged are passed as an argument. <code>pkt_space</code> is one of the <code>QUIC_PN_SPACE_*</code> values, specifying the packet number space of the containing packet. <code>rx_time</code> is the time the frame was received.</p>
<p>This function causes <code>on_acked</code> callbacks to be invoked on applicable packets.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>ossl_ackm_ack_range_st {</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Represents an inclusive range of packet numbers [start, end].</span></div>
<div class="line"><span class="comment">     * start must be &lt;= end.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    QUIC_PN start, end;</div>
<div class="line">} OSSL_ACKM_ACK_RANGE;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>ossl_ackm_ack {</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * A sequence of packet number ranges [[start, end]...].</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * The ranges must be sorted in descending order, for example:</span></div>
<div class="line"><span class="comment">     *      [ 95, 100]</span></div>
<div class="line"><span class="comment">     *      [ 90,  92]</span></div>
<div class="line"><span class="comment">     *      etc.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * As such, ack_ranges[0].end is always the highest packet number</span></div>
<div class="line"><span class="comment">     * being acknowledged and ack_ranges[num_ack_ranges-1].start is</span></div>
<div class="line"><span class="comment">     * always the lowest packet number being acknowledged.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * num_ack_ranges must be greater than zero, as an ACK frame must</span></div>
<div class="line"><span class="comment">     * acknowledge at least one packet number.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keyword">const</span> OSSL_ACKM_ACK_RANGE  *ack_ranges;</div>
<div class="line">    <span class="keywordtype">size_t</span>                      num_ack_ranges;</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a>                   delay_time;</div>
<div class="line">    uint64_t                    ect0, ect1, ecnce;</div>
<div class="line">    <span class="comment">/* 1 if the ect0, ect1 and ecnce fields are valid */</span></div>
<div class="line">    <span class="keywordtype">char</span>                        ecn_present;</div>
<div class="line">} OSSL_ACKM_ACK;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ossl_ackm_on_rx_ack_frame(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keyword">const</span> OSSL_ACKM_ACK *ack,</div>
<div class="line">                              <span class="keywordtype">int</span> pkt_space, <a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> rx_time);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md284"></a>
On Packet Space Discarded</h2>
<p>This must be called whenever a packet number space is discarded. ACK-tracking information for the number space is thrown away. Any previously provided <code>OSSL_ACKM_TX_PKT</code> structures have their <code>on_discarded</code> callback invoked, providing an opportunity for them to be freed.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_on_pkt_space_discarded(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> pkt_space);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md285"></a>
On Handshake Confirmed</h2>
<p>This should be called by the caller when the QUIC handshake is confirmed. The Probe Timeout (PTO) algorithm behaves differently depending on whether the QUIC handshake is confirmed yet.</p>
<p>Returns 1 on success.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_on_handshake_confirmed(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md286"></a>
On Timeout</h2>
<p>This must be called whenever the loss detection deadline expires.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_on_timeout(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md287"></a>
Queries</h1>
<p>These functions allow information about the status of the ACK manager to be obtained.</p>
<h2><a class="anchor" id="autotoc_md288"></a>
Get Loss Detection Deadline</h2>
<p>This returns a deadline after which <code>ossl_ackm_on_timeout</code> should be called.</p>
<p>If it is <code>OSSL_TIME_INFINITY</code>, no timeout is currently active.</p>
<p>The value returned by this function may change after any call to any of the event functions above is made.</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> ossl_ackm_get_loss_detection_deadline(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md289"></a>
Get ACK Frame</h2>
<p>This returns a pointer to a <code>OSSL_ACKM_ACK</code> structure representing the information which should be packed into an ACK frame and transmitted.</p>
<p>This generates an ACK frame regardless of whether the ACK manager thinks one should currently be sent. To determine if the ACK manager thinks an ACK frame should be sent, use <code>ossl_ackm_is_ack_desired</code>, discussed below.</p>
<p>If no new ACK frame is currently needed, returns NULL. After calling this function, calling the function immediately again will return NULL.</p>
<p>The structure pointed to by the returned pointer, and the referenced ACK range structures, are guaranteed to remain valid until the next call to any <code>OSSL_ACKM</code> function. After such a call is made, all fields become undefined.</p>
<p>This function is used to provide ACK frames for acknowledging packets which have been received and notified to the ACK manager via <code>ossl_ackm_on_rx_packet</code>.</p>
<p>Calling this function clears the flag returned by <code>ossl_ackm_is_ack_desired</code> and the deadline returned by <code>ossl_ackm_get_ack_deadline</code>.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> OSSL_ACKM_ACK *ossl_ackm_get_ack_frame(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> pkt_space);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md290"></a>
Is ACK Desired</h2>
<p>This returns 1 if the ACK manager thinks an ACK frame ought to be generated and sent at this time. <code>ossl_ackm_get_ack_frame</code> will always provide an ACK frame whether or not this returns 1, so it is suggested that you call this function first to determine whether you need to generate an ACK frame.</p>
<p>The return value of this function can change based on calls to <code>ossl_ackm_on_rx_packet</code> and based on the passage of time (see <code>ossl_ackm_get_ack_deadline</code>).</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_is_ack_desired(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> pkt_space);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md291"></a>
Get ACK Deadline</h2>
<p>The ACK manager may defer generation of ACK frames to optimize performance. For example, after a packet requiring acknowledgement is received, it may decide to wait until a few more packets are received before generating an ACK frame, so that a single ACK frame can acknowledge all of them. However, if further packets do not arrive, an ACK frame must be generated anyway within a certain amount of time.</p>
<p>This function returns the deadline at which the return value of <code>ossl_ackm_is_ack_desired</code> will change to 1, or <code>OSSL_TIME_INFINITY</code>, which means that no deadline is currently applicable. If the deadline has already passed, it may either return that deadline or <code>OSSL_TIME_ZERO</code>.</p>
<div class="fragment"><div class="line"><a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> ossl_ackm_get_ack_deadline(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> pkt_space);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md292"></a>
Is RX PN Processable</h2>
<p>Returns 1 if the given RX packet number is “processable”. A processable PN is one that is not either</p>
<ul>
<li>duplicate, meaning that we have already been passed such a PN in a call to <code>ossl_ackm_on_rx_packet</code>; or</li>
<li>written off, meaning that the PN is so old that we have stopped tracking state for it (meaning we cannot tell whether it is a duplicate and cannot process it safely).</li>
</ul>
<p>This should be called for a packet before attempting to process its contents. Failure to do so may may result in processing a duplicated packet in violation of the RFC.</p>
<p>The returrn value of this function transitions from 1 to 0 for a given PN once that PN is passed to ossl_ackm_on_rx_packet, thus this function must be used before calling <code>ossl_ackm_on_rx_packet</code>.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_is_rx_pn_processable(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, QUIC_PN pn, <span class="keywordtype">int</span> pkt_space);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md293"></a>
Get Probe Packet</h2>
<p>This determines if the ACK manager is requesting any probe packets to be transmitted.</p>
<p>The user calls <code>ossl_ackm_get_probe_request</code>. The structure pointed to by <code>info</code> is filled and the function returns 1 on success.</p>
<p>The fields of <code>OSSL_ACKM_PROBE_INFO</code> record the number of probe requests of each type which are outstanding. In short:</p>
<ul>
<li><code>handshake</code> designates the number of ACK-eliciting Handshake packets being requested. This is equivalent to <code>SendOneAckElicitingHandshakePacket()</code> in RFC 9002.</li>
<li><code>padded_initial</code> designates the number of ACK-eliciting padded Initial packets being requested. This is equivalent to <code>SendOneAckElicitingPaddedInitialPacket()</code> in RFC 9002.</li>
<li><code>pto</code> designates the number of ACK-eliciting outstanding probe events corresponding to each packet number space. This is equivalent to <code>SendOneOrTwoAckElicitingPackets(pn_space)</code> in RFC 9002.</li>
</ul>
<p>Once the caller has processed these requests, the caller must clear these outstanding requests by calling <code>ossl_ackm_get_probe_request</code> with <code>clear</code> set to 1. If <code>clear</code> is non-zero, the current values are returned and then zeroed, so that the next call to <code>ossl_ackm_get_probe_request</code> (if made immediately) will return zero values for all fields.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structossl__ackm__probe__info__st.html">ossl_ackm_probe_info_st</a> {</div>
<div class="line">    uint32_t handshake;</div>
<div class="line">    uint32_t padded_initial;</div>
<div class="line">    uint32_t pto[QUIC_PN_SPACE_NUM];</div>
<div class="line">} <a class="code hl_struct" href="structossl__ackm__probe__info__st.html">OSSL_ACKM_PROBE_INFO</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> ossl_ackm_get_probe_request(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> clear,</div>
<div class="line">                                <a class="code hl_struct" href="structossl__ackm__probe__info__st.html">OSSL_ACKM_PROBE_INFO</a> *info);</div>
<div class="ttc" id="astructossl__ackm__probe__info__st_html"><div class="ttname"><a href="structossl__ackm__probe__info__st.html">ossl_ackm_probe_info_st</a></div><div class="ttdef"><b>Definition</b> quic_ackm.h:233</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md294"></a>
Get Largest Unacked Packet Number</h2>
<p>This gets the largest unacknowledged packet number in the given packet number space. The packet number is written to <code>*pn</code>. Returns 1 on success.</p>
<p>This is needed so that packet encoders can determine with what length to encode the abridged packet number in the packet header.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> ossl_ackm_get_largest_unacked(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm, <span class="keywordtype">int</span> pkt_space, QUIC_PN *pn);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md295"></a>
Callback Functionality</h1>
<p>The ACK manager supports optional callback functionality when its deadlines are updated. By default, the callback functionality is not enabled. To use the callback functionality, call either or both of the following functions with a non-NULL function pointer:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ossl_ackm_set_loss_detection_deadline_callback(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm,</div>
<div class="line">                                                    <span class="keywordtype">void</span> (*fn)(<a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> deadline,</div>
<div class="line">                                                               <span class="keywordtype">void</span> *arg),</div>
<div class="line">                                                    <span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ossl_ackm_set_ack_deadline_callback(<a class="code hl_struct" href="structossl__ackm__st.html">OSSL_ACKM</a> *ackm,</div>
<div class="line">                                         <span class="keywordtype">void</span> (*fn)(<a class="code hl_struct" href="struct_o_s_s_l___t_i_m_e.html">OSSL_TIME</a> deadline,</div>
<div class="line">                                                    <span class="keywordtype">int</span> pkt_space,</div>
<div class="line">                                                    <span class="keywordtype">void</span> *arg),</div>
<div class="line">                                         <span class="keywordtype">void</span> *arg);</div>
</div><!-- fragment --><p>Callbacks can be subsequently disabled by calling these functions with a NULL function pointer. The callbacks are not called at the time that they are set, therefore it is recommended to call them immediately after the call to <code>ossl_ackm_new</code>.</p>
<p>The loss detection deadline callback is called whenever the value returned by <code>ossl_ackm_get_loss_detection_deadline</code> changes.</p>
<p>The ACK deadline callback is called whenever the value returned by <code>ossl_ackm_get_ack_deadline</code> changes for a given packet space.</p>
<p>The <code>deadline</code> argument reflects the value which will be newly returned by the corresponding function. If the configured callback calls either of these functions, the returned value will reflect the new deadline. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
