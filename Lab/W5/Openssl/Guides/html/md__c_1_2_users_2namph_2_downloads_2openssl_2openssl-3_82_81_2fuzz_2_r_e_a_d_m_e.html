<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl Guides: Fuzzing OpenSSL</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Openssl Guides
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Fuzzing OpenSSL</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>OpenSSL can use either LibFuzzer or AFL to do fuzzing.</p>
<h1><a class="anchor" id="autotoc_md519"></a>
LibFuzzer</h1>
<p>How to fuzz OpenSSL with <a href="http://llvm.org/docs/LibFuzzer.html">libfuzzer</a>, starting from a vanilla+OpenSSH server Ubuntu install.</p>
<h1><a class="anchor" id="autotoc_md520"></a>
With <code>clang</code> from a package manager</h1>
<p>Install <code>clang</code>, which <a href="http://llvm.org/docs/LibFuzzer.html#fuzzer-usage">ships with <code>libfuzzer</code></a> since version 6.0: </p><pre class="fragment">sudo apt-get install clang
</pre><p> Configure <code>openssl</code> for fuzzing. For now, you'll still need to pass in the path to the <code>libFuzzer</code> library file while configuring; this is represented as <code>$PATH_TO_LIBFUZZER</code> below. A typical value would be <code>/usr/lib/llvm-7/lib/clang/7.0.1/lib/linux/libclang_rt.fuzzer-x86_64.a</code>. </p><pre class="fragment">CC=clang ./config enable-fuzz-libfuzzer \
        --with-fuzzer-lib=$PATH_TO_LIBFUZZER \
        -DPEDANTIC enable-asan enable-ubsan no-shared \
        -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION \
        -fsanitize=fuzzer-no-link \
        enable-ec_nistp_64_gcc_128 -fno-sanitize=alignment \
        enable-weak-ssl-ciphers enable-rc5 enable-md2 \
        enable-ssl3 enable-ssl3-method enable-nextprotoneg \
        --debug
</pre><p> Clang uses the gcc libstdc++ library so this must also be installed. You can check which version of gcc clang is using like this: </p><pre class="fragment">$ clang --verbose
Ubuntu clang version 14.0.0-1ubuntu1.1
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/bin
Found candidate GCC installation: /usr/bin/../lib/gcc/i686-linux-gnu/12
Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/10
Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/11
Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/12
Selected GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/12
Candidate multilib: .;@m64
Selected multilib: .;@m64
</pre><p> So, in the above example clang is using gcc version 12. Ensure that the selected gcc version has the relevant libstdc++ files installed: </p><pre class="fragment">$ ls /usr/lib/gcc/x86_64-linux-gnu/12 | grep stdc++
libstdc++.a
libstdc++fs.a
libstdc++.so
</pre><p> On Ubuntu for gcc-12 this requires the libstdc++-12-dev package installed. </p><pre class="fragment">$ sudo apt-get install libstdc++-12-dev
</pre><p> Compile: </p><pre class="fragment">sudo apt-get install make
make clean
LDCMD=clang++ make -j4
</pre><p> Finally, perform the actual fuzzing: </p><pre class="fragment">fuzz/helper.py $FUZZER
</pre><p> where $FUZZER is one of the executables in <code>fuzz/</code>. It will run until you stop it.</p>
<p>If you get a crash, you should find a corresponding input file in <code>fuzz/corpora/$FUZZER-crash/</code>.</p>
<h1><a class="anchor" id="autotoc_md521"></a>
With <code>clang</code> from source/pre-built binaries</h1>
<p>You may also wish to use a pre-built binary from the <a href="http://releases.llvm.org/download.html">LLVM Download site</a>, or to <a href="https://clang.llvm.org/get_started.html">build <code>clang</code> from source</a>. After adding <code>clang</code> to your path and locating the <code>libfuzzer</code> library file, the procedure for configuring fuzzing is the same, except that you also need to specify a <code>--with-fuzzer-include</code> option, which should be the parent directory of the prebuilt fuzzer library. This is represented as <code>$PATH_TO_LIBFUZZER_DIR</code> below. </p><pre class="fragment">CC=clang ./config enable-fuzz-libfuzzer \
        --with-fuzzer-include=$PATH_TO_LIBFUZZER_DIR \
        --with-fuzzer-lib=$PATH_TO_LIBFUZZER \
        -DPEDANTIC enable-asan enable-ubsan no-shared \
        -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION \
        -fsanitize=fuzzer-no-link \
        enable-ec_nistp_64_gcc_128 -fno-sanitize=alignment \
        enable-weak-ssl-ciphers enable-rc5 enable-md2 \
        enable-ssl3 enable-ssl3-method enable-nextprotoneg \
        --debug
</pre> <h1><a class="anchor" id="autotoc_md522"></a>
AFL</h1>
<p>This is an alternative to using LibFuzzer.</p>
<p>Configure for fuzzing: </p><pre class="fragment">sudo apt-get install afl-clang
CC=afl-clang-fast ./config enable-fuzz-afl no-shared no-module \
    -DPEDANTIC enable-tls1_3 enable-weak-ssl-ciphers enable-rc5 \
    enable-md2 enable-ssl3 enable-ssl3-method enable-nextprotoneg \
    enable-ec_nistp_64_gcc_128 -fno-sanitize=alignment \
    --debug
make clean
make
</pre><p> The following options can also be enabled: enable-asan, enable-ubsan, enable-msan</p>
<p>Run one of the fuzzers: </p><pre class="fragment">afl-fuzz -i fuzz/corpora/$FUZZER -o fuzz/corpora/$FUZZER/out fuzz/$FUZZER
</pre><p> Where $FUZZER is one of the executables in <code>fuzz/</code>.</p>
<h1><a class="anchor" id="autotoc_md523"></a>
Reproducing issues</h1>
<p>If a fuzzer generates a reproducible error, you can reproduce the problem using the fuzz/*-test binaries and the file generated by the fuzzer. They binaries don't need to be built for fuzzing, there is no need to set CC or the call config with enable-fuzz-* or -fsanitize-coverage, but some of the other options above might be needed. For instance the enable-asan or enable-ubsan option might be useful to show you when the problem happens. For the client and server fuzzer it might be needed to use -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION to reproduce the generated random numbers.</p>
<p>To reproduce the crash you can run: </p><pre class="fragment">fuzz/$FUZZER-test $file
</pre><p> To do all the tests of a specific fuzzer such as asn1 you can run </p><pre class="fragment">fuzz/asn1-test fuzz/corpora/asn1
</pre><p> or make test TESTS=fuzz_test_asn1</p>
<p>To run several fuzz tests you can use for instance: </p><pre class="fragment">make test TESTS='test_fuzz_cmp test_fuzz_cms'
</pre><p> To run all fuzz tests you can use: </p><pre class="fragment">make test TESTS='test_fuzz_*'
</pre> <h1><a class="anchor" id="autotoc_md524"></a>
Random numbers</h1>
<p>The client and server fuzzer normally generate random numbers as part of the TLS connection setup. This results in the coverage of the fuzzing corpus changing depending on the random numbers. This also has an effect for coverage of the rest of the test suite and you see the coverage change for each commit even when no code has been modified.</p>
<p>Since we want to maximize the coverage of the fuzzing corpus, the client and server fuzzer will use predictable numbers instead of the random numbers. This is controlled by the FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION define.</p>
<p>The coverage depends on the way the numbers are generated. We don't disable any check of hashes, but the corpus has the correct hash in it for the random numbers that were generated. For instance the client fuzzer will always generate the same client hello with the same random number in it, and so the server, as emulated by the file, can be generated for that client hello.</p>
<h1><a class="anchor" id="autotoc_md525"></a>
Coverage changes</h1>
<p>Since the corpus depends on the default behaviour of the client and the server, changes in what they send by default will have an impact on the coverage. The corpus will need to be updated in that case.</p>
<h1><a class="anchor" id="autotoc_md526"></a>
Updating the corpus</h1>
<p>The client and server corpus is generated with multiple config options:</p>
<ul>
<li>The options as documented above</li>
<li>Without enable-ec_nistp_64_gcc_128 and without &ndash;debug</li>
<li>With no-asm</li>
<li>Using 32 bit</li>
<li>A default config, plus options needed to generate the fuzzer.</li>
</ul>
<p>The libfuzzer merge option is used to add the additional coverage from each config to the minimal set.</p>
<h1><a class="anchor" id="autotoc_md527"></a>
Minimizing the corpus</h1>
<p>When you have gathered corpus data from more than one fuzzer run or for any other reason want to minimize the data in some corpus subdirectory <code>fuzz/corpora/DIR</code> this can be done as follows: </p><pre class="fragment">mkdir fuzz/corpora/NEWDIR
fuzz/$FUZZER -merge=1 fuzz/corpora/NEWDIR fuzz/corpora/DIR
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
