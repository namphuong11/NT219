<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openssl Guides: Perl scripts for assembler sources</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Openssl Guides
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Perl scripts for assembler sources</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The perl scripts in this directory are my 'hack' to generate multiple different assembler formats via the one original script.</p>
<p>The way to use this library is to start with adding the path to this directory and then include it. </p><pre class="fragment">push(@INC,"perlasm","../../perlasm");
require "x86asm.pl";
</pre><p> The first thing we do is setup the file and type of assembler </p><pre class="fragment">&amp;asm_init($ARGV[0]);
</pre><p> The first argument is the 'type'. Currently <code>cpp</code>, <code>sol</code>, <code>a.out</code>, <code>elf</code> or <code>win32</code>. The second argument is the file name.</p>
<p>The reciprocal function is <code>&amp;asm_finish()</code> which should be called at the end.</p>
<p>There are two main 'packages'. <code>x86ms.pl</code>, which is the Microsoft assembler, and <code>x86unix.pl</code> which is the unix (gas) version.</p>
<p>Functions of interest are: </p><pre class="fragment">&amp;external_label("des_SPtrans");  declare and external variable
&amp;LB(reg);                        Low byte for a register
&amp;HB(reg);                        High byte for a register
&amp;BP(off,base,index,scale)        Byte pointer addressing
&amp;DWP(off,base,index,scale)       Word pointer addressing
&amp;stack_push(num)                 Basically a 'sub esp, num*4' with extra
&amp;stack_pop(num)                  inverse of stack_push
&amp;function_begin(name,extra)      Start a function with pushing of
                                 edi, esi, ebx and ebp. extra is extra win32
                                 external info that may be required.
&amp;function_begin_B(name,extra)    Same as normal function_begin but no
                                 pushing.
&amp;function_end(name)              Call at end of function.
&amp;function_end_A(name)            Standard pop and ret, for use inside
                                 functions.
&amp;function_end_B(name)            Call at end but with pop or ret.
&amp;swtmp(num)                      Address on stack temp word.
&amp;wparam(num)                     Parameter number num, that was push in
                                 C convention.  This all works over pushes
                                 and pops.
&amp;comment("hello there")          Put in a comment.
&amp;label("loop")                   Refer to a label, normally a jmp target.
&amp;set_label("loop")               Set a label at this point.
&amp;data_word(word)                 Put in a word of data.
</pre><p> So how does this all hold together? Given </p><pre class="fragment">int calc(int len, int *data)
{
    int i,j=0;

    for (i=0; i&lt;len; i++)
    {
        j+=other(data[i]);
    }
}
</pre><p> So a very simple version of this function could be coded as </p><pre class="fragment">push(@INC,"perlasm","../../perlasm");
require "x86asm.pl";

&amp;asm_init($ARGV[0]);

&amp;external_label("other");

$tmp1=   "eax";
$j=      "edi";
$data=   "esi";
$i=      "ebp";

&amp;comment("a simple function");
&amp;function_begin("calc");
&amp;mov(    $data,     &amp;wparam(1)); # data
&amp;xor(    $j,        $j);
&amp;xor(    $i,        $i);

&amp;set_label("loop");
&amp;cmp(    $i,        &amp;wparam(0));
&amp;jge(    &amp;label("end"));

&amp;mov(    $tmp1,     &amp;DWP(0,$data,$i,4));
&amp;push(   $tmp1);
&amp;call(   "other");
&amp;add(    $j,        "eax");
&amp;pop(    $tmp1);
&amp;inc(    $i);
&amp;jmp(    &amp;label("loop"));

&amp;set_label("end");
&amp;mov(    "eax",     $j);

&amp;function_end("calc");

&amp;asm_finish();
</pre><p> The above example is very very unoptimised but gives an idea of how things work.</p>
<p>There is also a cbc mode function generator in cbc.pl </p><pre class="fragment">&amp;cbc($name,
     $encrypt_function_name,
     $decrypt_function_name,
     $true_if_byte_swap_needed,
     $parameter_number_for_iv,
     $parameter_number_for_encrypt_flag,
     $first_parameter_to_pass,
     $second_parameter_to_pass,
     $third_parameter_to_pass);
</pre><p> So for example, given </p><pre class="fragment">void BF_encrypt(BF_LONG *data,BF_KEY *key);
void BF_decrypt(BF_LONG *data,BF_KEY *key);
void BF_cbc_encrypt(unsigned char *in, unsigned char *out, long length,
                    BF_KEY *ks, unsigned char *iv, int enc);

&amp;cbc("BF_cbc_encrypt","BF_encrypt","BF_encrypt",1,4,5,3,-1,-1);

&amp;cbc("des_ncbc_encrypt","des_encrypt","des_encrypt",0,4,5,3,5,-1);
&amp;cbc("des_ede3_cbc_encrypt","des_encrypt3","des_decrypt3",0,6,7,3,4,5);
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
